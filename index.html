<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCOLARIS - Plateforme de Gestion Scolaire</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ============================================
           VARIABLES & RESET
        ============================================ */
        :root {
            --couleur-principale: #2C3E50;
            --couleur-secondaire: #3498DB;
            --couleur-accent: #E74C3C;
            --couleur-success: #27AE60;
            --couleur-warning: #F39C12;
            --couleur-info: #17A2B8;
            --couleur-fond: #F8F9FA;
            --couleur-bordure: #E1E5E9;
            --couleur-text: #333333;
            --couleur-text-light: #666666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
        }

        body {
            background-color: var(--couleur-fond);
            color: var(--couleur-text);
            min-height: 100vh;
        }

        /* ============================================
           PAGE DE CONNEXION
        ============================================ */
        .login-page {
            background: linear-gradient(135deg, var(--couleur-principale) 0%, #1A2530 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
        }

        .login-header {
            background-color: var(--couleur-principale);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .login-header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .login-content {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--couleur-principale);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--couleur-secondaire);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background-color: var(--couleur-secondaire);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .login-footer {
            text-align: center;
            padding-top: 20px;
            margin-top: 20px;
            font-size: 0.8rem;
            color: #666;
        }

        .setup-link {
            text-align: center;
            margin-top: 15px;
        }

        .setup-link a {
            color: var(--couleur-secondaire);
            text-decoration: none;
            cursor: pointer;
        }

        /* ============================================
           INTERFACE PRINCIPALE
        ============================================ */
        .dashboard-page {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header-principal {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0 20px;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--couleur-bordure);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--couleur-principale);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--couleur-secondaire);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Menu */
        .menu-horizontal {
            background-color: white;
            border-bottom: 1px solid var(--couleur-bordure);
            overflow-x: auto;
        }

        .menu-items {
            display: flex;
            list-style: none;
            min-width: max-content;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .menu-item:hover {
            background-color: #f8f9fa;
            color: var(--couleur-principale);
        }

        .menu-item.active {
            border-bottom-color: var(--couleur-secondaire);
            color: var(--couleur-secondaire);
            background-color: #f0f7ff;
        }

        /* Contenu principal */
        .contenu-principal {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
        }

        /* ============================================
           COMPOSANTS COMMUNS
        ============================================ */
        /* Boutons */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: var(--couleur-secondaire);
            color: white;
        }

        .btn-secondary {
            background-color: white;
            color: var(--couleur-principale);
            border: 1px solid var(--couleur-bordure);
        }

        .btn-success {
            background-color: var(--couleur-success);
            color: white;
        }

        .btn-danger {
            background-color: var(--couleur-accent);
            color: white;
        }

        .btn-warning {
            background-color: var(--couleur-warning);
            color: white;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        /* Cards */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-top: 4px solid var(--couleur-secondaire);
        }

        .card-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--couleur-principale);
            margin-bottom: 5px;
        }

        /* Tableaux */
        .table-container {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--couleur-bordure);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.1rem;
            color: var(--couleur-principale);
            font-weight: 600;
        }

        .table-content {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #F8F9FA;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--couleur-principale);
            border-bottom: 1px solid var(--couleur-bordure);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--couleur-bordure);
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        /* Badges */
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-primary { background-color: #D6EAF8; color: #2C3E50; }
        .badge-success { background-color: #D5EDDA; color: #155724; }
        .badge-warning { background-color: #FFF3CD; color: #856404; }
        .badge-danger { background-color: #F8D7DA; color: #721C24; }
        .badge-info { background-color: #D1ECF1; color: #0C5460; }

        /* Formulaires */
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .form-title {
            font-size: 1.2rem;
            color: var(--couleur-principale);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--couleur-bordure);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--couleur-principale);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--couleur-bordure);
            border-radius: 4px;
            font-size: 0.95rem;
        }

        /* Onglets */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--couleur-bordure);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            white-space: nowrap;
        }

        .tab.active {
            border-bottom-color: var(--couleur-secondaire);
            color: var(--couleur-secondaire);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--couleur-bordure);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            color: var(--couleur-principale);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--couleur-bordure);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Animations */
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mention légale */
        .mention-legale {
            background-color: #FFF3CD;
            border: 1px solid #FFEAA7;
            padding: 15px;
            border-radius: 6px;
            margin-top: 30px;
            font-size: 0.9rem;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ============================================
           STYLES SPÉCIFIQUES
        ============================================ */
        /* Sanctions */
        .sanction-card {
            border-left: 4px solid var(--couleur-accent);
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .sanction-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
        }

        .sanction-retenue { background-color: #ffeaa7; color: #856404; }
        .sanction-avertissement { background-color: #ffcccc; color: #721c24; }
        .sanction-exclusion { background-color: #f8d7da; color: #721c24; }
        .sanction-blame { background-color: #fff3cd; color: #856404; }

        /* Cahier de textes */
        .cours-session {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .cours-session:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .cours-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .cours-matiere {
            font-weight: bold;
            color: var(--couleur-principale);
        }

        .cours-horaire {
            color: #666;
            font-size: 0.9rem;
        }

        /* Observations */
        .observation-card {
            border-left: 4px solid #3498DB;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .observation-positive { border-left-color: #27AE60; }
        .observation-negative { border-left-color: #E74C3C; }
        .observation-neutre { border-left-color: #95A5A6; }

        /* Emploi du temps */
        .emploi-container {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 1px;
            background-color: #e1e5e9;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            overflow: hidden;
        }

        .emploi-cell {
            background-color: white;
            padding: 8px;
            min-height: 80px;
            font-size: 0.85rem;
        }

        .emploi-header {
            font-weight: bold;
            text-align: center;
            background-color: var(--couleur-principale);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emploi-creneau {
            background-color: #e8f4fc;
            border-left: 3px solid var(--couleur-secondaire);
            padding: 6px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .emploi-creneau:hover {
            background-color: #d1ecf1;
        }

        /* ============================================
           RESPONSIVE DESIGN
        ============================================ */
        @media (max-width: 768px) {
            .menu-horizontal {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 10px;
            }
            
            .menu-items {
                min-width: max-content;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
            
            .table-content table {
                min-width: 700px;
            }
            
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .user-info {
                align-self: flex-end;
                margin-top: -40px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .emploi-container {
                grid-template-columns: 60px repeat(5, 1fr);
                font-size: 0.75rem;
            }
            
            .emploi-cell {
                padding: 4px;
                min-height: 60px;
            }
        }

        @media (max-width: 480px) {
            .login-container {
                margin: 10px;
                max-width: none;
            }
            
            .modal-content {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .menu-item span {
                display: none;
            }
            
            .menu-item i {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--couleur-secondaire);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="loginPage" class="login-page">
        <div class="login-container" id="loginContainer">
            <div class="login-header">
                <h1 id="loginTitle">SCOLARIS</h1>
                <div id="loginSubtitle">Plateforme de Gestion Scolaire</div>
            </div>
            <div class="login-content">
                <div id="alertMessage" class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Première connexion :</strong><br>
                        Identifiant: <code>admin</code><br>
                        Mot de passe: <code>scolaris2025</code>
                    </div>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="identifiant">Identifiant</label>
                        <input type="text" id="identifiant" class="form-control" value="admin">
                    </div>
                    <div class="form-group">
                        <label for="password">Mot de passe</label>
                        <input type="password" id="password" class="form-control" value="scolaris2025">
                    </div>
                    <button type="submit" class="btn-login">
                        <i class="fas fa-sign-in-alt"></i> Se connecter
                    </button>
                </form>
                <div class="setup-link">
                    <a onclick="showSetup()">Configurer un nouvel établissement</a>
                </div>
                <div class="setup-link">
                    <small>Créer un compte gratuit sur <a href="https://jsonbin.io" target="_blank">JSONBin.io</a> et coller votre API Key ci-dessous</small>
                    <input type="text" id="jsonbinKey" class="form-control" style="margin-top: 10px;" 
                           placeholder="Votre API Key JSONBin.io">
                    <input type="text" id="jsonbinId" class="form-control" style="margin-top: 5px;" 
                           placeholder="ID de votre bin (optionnel)">
                </div>
                <div class="login-footer">
                    Cette plateforme est une simulation fictive à usage pédagogique.
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard (caché par défaut) -->
    <div id="dashboardPage" class="dashboard-page" style="display: none;">
        <header class="header-principal">
            <div class="header-top">
                <div class="logo-container">
                    <div class="logo">SCOLARIS</div>
                    <div class="etablissement-info" id="etablissementInfo"></div>
                </div>
                <div class="user-info">
                    <div class="user-details">
                        <div class="user-name" id="userName"></div>
                        <div class="user-role" id="userRole"></div>
                    </div>
                    <div class="user-avatar" id="userAvatar"></div>
                    <button class="btn btn-secondary btn-small" onclick="deconnexion()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            <nav class="menu-horizontal">
                <ul class="menu-items" id="menuItems"></ul>
            </nav>
        </header>
        <main class="contenu-principal" id="contenuPrincipal">
            <div class="loading">
                <div class="spinner"></div>
                <p>Chargement des données...</p>
            </div>
        </main>
        <div id="modalGenerique" class="modal"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION JSONBIN.IO
        // ============================================
        const JSONBIN_API_URL = 'https://api.jsonbin.io/v3/b';
        let JSONBIN_API_KEY = '$2a$10$QePjhfYZXjA/daRY.sqpM.GmclPUUWdxMoTH6Y0QwMvSG8yjTxsu.';
        let JSONBIN_BIN_ID = '69633ba743b1c97be92826ab';
        let SCOLARIS_DATA = null;
        let utilisateurCourant = null;

        // ============================================
        // FONCTIONS API JSONBIN.IO
        // ============================================
        async function chargerDonnees() {
            try {
                if (!JSONBIN_API_KEY) {
                    JSONBIN_API_KEY = localStorage.getItem('JSONBIN_API_KEY') || '';
                    JSONBIN_BIN_ID = localStorage.getItem('JSONBIN_BIN_ID') || '';
                    
                    if (!JSONBIN_API_KEY) {
                        throw new Error('Veuillez configurer votre clé API JSONBin.io');
                    }
                }

                let url = '';
                let headers = {
                    'X-Master-Key': JSONBIN_API_KEY,
                    'Content-Type': 'application/json'
                };

                if (JSONBIN_BIN_ID) {
                    url = `${JSONBIN_API_URL}/${JSONBIN_BIN_ID}`;
                } else {
                    // Créer un nouveau bin
                    const defaultData = getDefaultData();
                    const response = await fetch(JSONBIN_API_URL, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(defaultData)
                    });
                    
                    if (!response.ok) throw new Error('Erreur de création du bin');
                    
                    const result = await response.json();
                    JSONBIN_BIN_ID = result.metadata.id;
                    localStorage.setItem('JSONBIN_BIN_ID', JSONBIN_BIN_ID);
                    SCOLARIS_DATA = defaultData;
                    return defaultData;
                }

                const response = await fetch(url, { headers });
                if (!response.ok) {
                    if (response.status === 404) {
                        // Bin non trouvé, créer un nouveau
                        const defaultData = getDefaultData();
                        await sauvegarderDonnees(defaultData);
                        SCOLARIS_DATA = defaultData;
                        return defaultData;
                    }
                    throw new Error('Erreur de chargement des données');
                }

                const result = await response.json();
                SCOLARIS_DATA = result.record;
                return result.record;
            } catch (error) {
                console.error('Erreur:', error);
                throw error;
            }
        }

        async function sauvegarderDonnees(donnees) {
            try {
                if (!JSONBIN_BIN_ID) {
                    throw new Error('Bin ID non configuré');
                }

                const response = await fetch(`${JSONBIN_API_URL}/${JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(donnees)
                });

                if (!response.ok) throw new Error('Erreur de sauvegarde');
                
                SCOLARIS_DATA = donnees;
                return { success: true };
            } catch (error) {
                console.error('Erreur de sauvegarde:', error);
                return { success: false, error: error.message };
            }
        }

        function getDefaultData() {
            return {
                system: {
                    nom: "SCOLARIS",
                    version: "5.1.0",
                    etablissement: {
                        nom: "Nouvel établissement",
                        type: "Collège public",
                        adresse: "",
                        ville: "",
                        telephone: "",
                        email: "",
                        annee_scolaire: new Date().getFullYear() + "-" + (new Date().getFullYear() + 1),
                        directeur: ""
                    },
                    config: {
                        theme: "default",
                        notifications: true,
                        export_auto: false,
                        complexite_password: "moyenne"
                    }
                },
                utilisateurs: [],
                roles: [
                    { id: "admin_systeme", nom: "Administrateur système" },
                    { id: "proviseur", nom: "Proviseur" },
                    { id: "proviseur_adjoint", nom: "Proviseur adjoint" },
                    { id: "cpe", nom: "Conseiller Principal d'Éducation" },
                    { id: "secretariat", nom: "Secrétariat" },
                    { id: "enseignant", nom: "Enseignant" },
                    { id: "eleve", nom: "Élève" },
                    { id: "parent", nom: "Parent" }
                ],
                classes: [],
                eleves: [],
                matieres: [],
                notes: [],
                absences: [],
                retards: [],
                sanctions: [],
                observations: [],
                devoirs: [],
                cahier_textes: [],
                emploi_du_temps: [],
                messages: [],
                documents: []
            };
        }

        // ============================================
        // GESTION DE LA CONNEXION
        // ============================================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const identifiant = document.getElementById('identifiant').value;
            const password = document.getElementById('password').value;
            const apiKey = document.getElementById('jsonbinKey').value;
            const binId = document.getElementById('jsonbinId').value;
            
            if (apiKey) {
                JSONBIN_API_KEY = apiKey;
                localStorage.setItem('JSONBIN_API_KEY', apiKey);
                
                if (binId) {
                    JSONBIN_BIN_ID = binId;
                    localStorage.setItem('JSONBIN_BIN_ID', binId);
                }
            }
            
            if (!JSONBIN_API_KEY) {
                alert('Veuillez entrer votre clé API JSONBin.io');
                return;
            }
            
            try {
                const data = await chargerDonnees();
                
                if (!data.utilisateurs || data.utilisateurs.length === 0) {
                    showSetup();
                    return;
                }
                
                const utilisateur = data.utilisateurs.find(u => 
                    u.identifiant === identifiant && u.password === password && u.actif !== false
                );
                
                if (utilisateur) {
                    utilisateurCourant = utilisateur;
                    localStorage.setItem('SCOLARIS_USER', JSON.stringify(utilisateur));
                    showDashboard();
                } else {
                    document.getElementById('alertMessage').className = 'alert alert-danger';
                    document.getElementById('alertMessage').innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <div><strong>Erreur de connexion</strong><br>Identifiant ou mot de passe incorrect</div>`;
                }
            } catch (error) {
                alert('Erreur de connexion: ' + error.message);
            }
        });

        function showSetup() {
            document.getElementById('loginContainer').innerHTML = `
                <div class="login-header">
                    <h1>Configuration Initiale</h1>
                    <div>Création d'un nouvel établissement</div>
                </div>
                <div class="login-content">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>Configurez votre établissement scolaire</div>
                    </div>
                    <form id="setupForm">
                        <div class="form-group">
                            <label>Nom de l'établissement *</label>
                            <input type="text" id="etablissementNom" class="form-control" placeholder="Collège Victor Hugo" required>
                        </div>
                        <div class="form-group">
                            <label>Type d'établissement *</label>
                            <select id="etablissementType" class="form-control" required>
                                <option value="">Sélectionner</option>
                                <option value="Collège public">Collège public</option>
                                <option value="Collège privé">Collège privé</option>
                                <option value="Lycée général">Lycée général</option>
                                <option value="Lycée professionnel">Lycée professionnel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Adresse *</label>
                            <input type="text" id="etablissementAdresse" class="form-control" placeholder="12 Rue de l'Éducation" required>
                        </div>
                        <div class="form-group">
                            <label>Ville *</label>
                            <input type="text" id="etablissementVille" class="form-control" placeholder="75000 Paris" required>
                        </div>
                        <div class="form-group">
                            <label>Téléphone</label>
                            <input type="text" id="etablissementTelephone" class="form-control" placeholder="01 23 45 67 89">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="etablissementEmail" class="form-control" placeholder="contact@etablissement.fr">
                        </div>
                        <div class="form-group">
                            <label>Année scolaire *</label>
                            <input type="text" id="etablissementAnnee" class="form-control" value="${new Date().getFullYear()}-${new Date().getFullYear() + 1}" required>
                        </div>
                        <div class="form-group">
                            <label>Votre identifiant administrateur *</label>
                            <input type="text" id="adminIdentifiant" class="form-control" value="admin" required>
                        </div>
                        <div class="form-group">
                            <label>Mot de passe administrateur *</label>
                            <input type="password" id="adminPassword" class="form-control" value="scolaris2025" required>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn-login" style="background: #666;" onclick="location.reload()">Annuler</button>
                            <button type="submit" class="btn-login"><i class="fas fa-cogs"></i> Configurer</button>
                        </div>
                    </form>
                </div>`;
            
            document.getElementById('setupForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await initialiserNouvelEtablissement();
            });
        }

        async function initialiserNouvelEtablissement() {
            const donnees = getDefaultData();
            
            donnees.system.etablissement = {
                nom: document.getElementById('etablissementNom').value,
                type: document.getElementById('etablissementType').value,
                adresse: document.getElementById('etablissementAdresse').value,
                ville: document.getElementById('etablissementVille').value,
                telephone: document.getElementById('etablissementTelephone').value,
                email: document.getElementById('etablissementEmail').value,
                annee_scolaire: document.getElementById('etablissementAnnee').value,
                directeur: "À nommer"
            };
            
            donnees.utilisateurs = [{
                id: 1,
                nom: "Admin",
                prenom: "Système",
                role: "admin_systeme",
                identifiant: document.getElementById('adminIdentifiant').value,
                password: document.getElementById('adminPassword').value,
                email: document.getElementById('etablissementEmail').value || "admin@etablissement.fr",
                telephone: document.getElementById('etablissementTelephone').value,
                date_creation: new Date().toISOString().split('T')[0],
                actif: true,
                permissions: ["full_access"]
            }];

            const result = await sauvegarderDonnees(donnees);
            if (result.success) {
                alert('Établissement configuré avec succès ! Vous pouvez maintenant vous connecter.');
                location.reload();
            } else {
                alert('Erreur lors de la configuration: ' + result.error);
            }
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'flex';
            initialiserDashboard();
        }

        // ============================================
        // INITIALISATION DU DASHBOARD
        // ============================================
        async function initialiserDashboard() {
            // Charger les données
            await chargerDonnees();
            
            // Charger l'utilisateur courant
            const userStr = localStorage.getItem('SCOLARIS_USER');
            if (userStr) {
                utilisateurCourant = JSON.parse(userStr);
            } else {
                window.location.reload();
                return;
            }
            
            // Initialiser les données par défaut
            initialiserDonneesParDefaut();
            
            // Afficher les informations
            afficherInformationsEtablissement();
            afficherInformationsUtilisateur();
            genererMenu();
            
            // Afficher le tableau de bord par défaut
            afficherTableauDeBord();
            
            // Gestion du modal
            document.getElementById('modalGenerique').addEventListener('click', function(e) {
                if (e.target === this) {
                    fermerModal();
                }
            });
        }

        function initialiserDonneesParDefaut() {
            let doitSauvegarder = false;
            
            // Initialiser les matières si vide
            if (!SCOLARIS_DATA.matieres || SCOLARIS_DATA.matieres.length === 0) {
                SCOLARIS_DATA.matieres = [
                    { id: 1, nom: "Français", coefficient: 3, couleur: "#4A6FA5", heures_semaine: 4 },
                    { id: 2, nom: "Mathématiques", coefficient: 3, couleur: "#D96459", heures_semaine: 4 },
                    { id: 3, nom: "Histoire-Géographie", coefficient: 2, couleur: "#388659", heures_semaine: 3 },
                    { id: 4, nom: "Sciences de la Vie et de la Terre", coefficient: 2, couleur: "#8E6C88", heures_semaine: 3 },
                    { id: 5, nom: "Langue Vivante A (Anglais)", coefficient: 2, couleur: "#3498DB", heures_semaine: 3 },
                    { id: 6, nom: "Physique-Chimie", coefficient: 2, couleur: "#F39C12", heures_semaine: 3 },
                    { id: 7, nom: "Technologie", coefficient: 1, couleur: "#8E44AD", heures_semaine: 2 },
                    { id: 8, nom: "Éducation Musicale", coefficient: 1, couleur: "#16A085", heures_semaine: 1 },
                    { id: 9, nom: "Arts Plastiques", coefficient: 1, couleur: "#D35400", heures_semaine: 1 },
                    { id: 10, nom: "Éducation Physique et Sportive", coefficient: 1, couleur: "#C0392B", heures_semaine: 2 }
                ];
                doitSauvegarder = true;
            }
            
            // Initialiser les autres tableaux si nécessaire
            if (!SCOLARIS_DATA.classes) SCOLARIS_DATA.classes = [];
            if (!SCOLARIS_DATA.eleves) SCOLARIS_DATA.eleves = [];
            if (!SCOLARIS_DATA.notes) SCOLARIS_DATA.notes = [];
            if (!SCOLARIS_DATA.absences) SCOLARIS_DATA.absences = [];
            if (!SCOLARIS_DATA.retards) SCOLARIS_DATA.retards = [];
            if (!SCOLARIS_DATA.sanctions) SCOLARIS_DATA.sanctions = [];
            if (!SCOLARIS_DATA.observations) SCOLARIS_DATA.observations = [];
            if (!SCOLARIS_DATA.devoirs) SCOLARIS_DATA.devoirs = [];
            if (!SCOLARIS_DATA.cahier_textes) SCOLARIS_DATA.cahier_textes = [];
            if (!SCOLARIS_DATA.emploi_du_temps) SCOLARIS_DATA.emploi_du_temps = [];
            if (!SCOLARIS_DATA.messages) SCOLARIS_DATA.messages = [];
            if (!SCOLARIS_DATA.documents) SCOLARIS_DATA.documents = [];
            
            if (doitSauvegarder) {
                sauvegarderDonnees(SCOLARIS_DATA);
            }
        }

        // ============================================
        // FONCTIONS UTILITAIRES
        // ============================================
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR');
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('fr-FR');
        }

        function ouvrirModal(html) {
            document.getElementById('modalGenerique').innerHTML = html;
            document.getElementById('modalGenerique').style.display = 'flex';
        }

        function fermerModal() {
            document.getElementById('modalGenerique').style.display = 'none';
        }

        function setActiveMenu(menuId) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.menu === menuId) {
                    item.classList.add('active');
                }
            });
        }

        function deconnexion() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                localStorage.removeItem('SCOLARIS_USER');
                location.reload();
            }
        }

        function afficherInformationsEtablissement() {
            const etablissement = SCOLARIS_DATA.system.etablissement;
            document.getElementById('etablissementInfo').innerHTML = `
                <div>${etablissement.nom}</div>
                <div style="font-size: 0.8rem; color: #666;">${etablissement.annee_scolaire}</div>`;
        }

        function afficherInformationsUtilisateur() {
            document.getElementById('userName').textContent = `${utilisateurCourant.prenom} ${utilisateurCourant.nom}`;
            document.getElementById('userRole').textContent = 
                SCOLARIS_DATA.roles.find(r => r.id === utilisateurCourant.role)?.nom || utilisateurCourant.role;
            document.getElementById('userAvatar').textContent = 
                utilisateurCourant.prenom.charAt(0) + utilisateurCourant.nom.charAt(0);
        }

        function genererMenu() {
            let menuHtml = '';
            const role = utilisateurCourant.role;
            
            if (role === 'admin_systeme' || role === 'proviseur') {
                menuHtml = `
                    <li class="menu-item active" data-menu="dashboard" onclick="afficherTableauDeBord()">
                        <i class="fas fa-tachometer-alt"></i> <span>Tableau de bord</span>
                    </li>
                    <li class="menu-item" data-menu="utilisateurs" onclick="afficherGestionUtilisateurs()">
                        <i class="fas fa-users-cog"></i> <span>Utilisateurs</span>
                    </li>
                    <li class="menu-item" data-menu="eleves" onclick="afficherGestionEleves()">
                        <i class="fas fa-user-graduate"></i> <span>Élèves</span>
                    </li>
                    <li class="menu-item" data-menu="enseignants" onclick="afficherGestionEnseignants()">
                        <i class="fas fa-chalkboard-teacher"></i> <span>Enseignants</span>
                    </li>
                    <li class="menu-item" data-menu="classes" onclick="afficherGestionClasses()">
                        <i class="fas fa-users"></i> <span>Classes</span>
                    </li>
                    <li class="menu-item" data-menu="matieres" onclick="afficherGestionMatieres()">
                        <i class="fas fa-book"></i> <span>Matières</span>
                    </li>
                    <li class="menu-item" data-menu="notes" onclick="afficherGestionNotes()">
                        <i class="fas fa-graduation-cap"></i> <span>Notes</span>
                    </li>
                    <li class="menu-item" data-menu="absences" onclick="afficherGestionAbsences()">
                        <i class="fas fa-user-clock"></i> <span>Absences</span>
                    </li>
                    <li class="menu-item" data-menu="sanctions" onclick="afficherGestionSanctions()">
                        <i class="fas fa-gavel"></i> <span>Sanctions</span>
                    </li>
                    <li class="menu-item" data-menu="observations" onclick="afficherGestionObservations()">
                        <i class="fas fa-sticky-note"></i> <span>Observations</span>
                    </li>
                    <li class="menu-item" data-menu="cahier_textes" onclick="afficherCahierTextes()">
                        <i class="fas fa-book-open"></i> <span>Cahier de textes</span>
                    </li>
                    <li class="menu-item" data-menu="emploi_temps" onclick="afficherEmploiDuTemps()">
                        <i class="fas fa-calendar-alt"></i> <span>Emploi du temps</span>
                    </li>
                    <li class="menu-item" data-menu="devoirs" onclick="afficherGestionDevoirs()">
                        <i class="fas fa-tasks"></i> <span>Devoirs</span>
                    </li>
                    <li class="menu-item" data-menu="parametres" onclick="afficherParametres()">
                        <i class="fas fa-cog"></i> <span>Paramètres</span>
                    </li>`;
            } else if (role === 'enseignant') {
                menuHtml = `
                    <li class="menu-item active" data-menu="dashboard" onclick="afficherTableauDeBord()">
                        <i class="fas fa-tachometer-alt"></i> <span>Tableau de bord</span>
                    </li>
                    <li class="menu-item" data-menu="mes_classes" onclick="afficherMesClasses()">
                        <i class="fas fa-chalkboard-teacher"></i> <span>Mes classes</span>
                    </li>
                    <li class="menu-item" data-menu="notes" onclick="afficherGestionNotes()">
                        <i class="fas fa-graduation-cap"></i> <span>Notes</span>
                    </li>
                    <li class="menu-item" data-menu="absences" onclick="afficherGestionAbsences()">
                        <i class="fas fa-user-clock"></i> <span>Absences</span>
                    </li>
                    <li class="menu-item" data-menu="observations" onclick="afficherGestionObservations()">
                        <i class="fas fa-sticky-note"></i> <span>Observations</span>
                    </li>
                    <li class="menu-item" data-menu="cahier_textes" onclick="afficherCahierTextes()">
                        <i class="fas fa-book-open"></i> <span>Cahier de textes</span>
                    </li>
                    <li class="menu-item" data-menu="emploi_temps" onclick="afficherEmploiDuTemps()">
                        <i class="fas fa-calendar-alt"></i> <span>Emploi du temps</span>
                    </li>
                    <li class="menu-item" data-menu="devoirs" onclick="afficherGestionDevoirs()">
                        <i class="fas fa-tasks"></i> <span>Devoirs</span>
                    </li>`;
            } else if (role === 'eleve') {
                menuHtml = `
                    <li class="menu-item active" data-menu="dashboard" onclick="afficherTableauDeBordEleve()">
                        <i class="fas fa-tachometer-alt"></i> <span>Tableau de bord</span>
                    </li>
                    <li class="menu-item" data-menu="mes_notes" onclick="afficherMesNotes()">
                        <i class="fas fa-graduation-cap"></i> <span>Mes notes</span>
                    </li>
                    <li class="menu-item" data-menu="emploi_temps" onclick="afficherEmploiDuTempsEleve()">
                        <i class="fas fa-calendar-alt"></i> <span>Emploi du temps</span>
                    </li>
                    <li class="menu-item" data-menu="mes_devoirs" onclick="afficherMesDevoirs()">
                        <i class="fas fa-tasks"></i> <span>Mes devoirs</span>
                    </li>
                    <li class="menu-item" data-menu="mes_observations" onclick="afficherMesObservations()">
                        <i class="fas fa-sticky-note"></i> <span>Mes observations</span>
                    </li>`;
            } else if (role === 'parent') {
                menuHtml = `
                    <li class="menu-item active" data-menu="dashboard" onclick="afficherTableauDeBordParent()">
                        <i class="fas fa-tachometer-alt"></i> <span>Tableau de bord</span>
                    </li>
                    <li class="menu-item" data-menu="enfants" onclick="afficherEnfants()">
                        <i class="fas fa-child"></i> <span>Mes enfants</span>
                    </li>
                    <li class="menu-item" data-menu="notes_enfants" onclick="afficherNotesEnfants()">
                        <i class="fas fa-graduation-cap"></i> <span>Notes</span>
                    </li>
                    <li class="menu-item" data-menu="absences_enfants" onclick="afficherAbsencesEnfants()">
                        <i class="fas fa-user-clock"></i> <span>Absences</span>
                    </li>
                    <li class="menu-item" data-menu="observations_enfants" onclick="afficherObservationsEnfants()">
                        <i class="fas fa-sticky-note"></i> <span>Observations</span>
                    </li>`;
            }
            
            document.getElementById('menuItems').innerHTML = menuHtml;
        }

        // ============================================
        // TABLEAU DE BORD
        // ============================================
        function afficherTableauDeBord() {
            const totalEleves = SCOLARIS_DATA.eleves.length;
            const totalClasses = SCOLARIS_DATA.classes.length;
            const totalEnseignants = SCOLARIS_DATA.utilisateurs.filter(u => u.role === 'enseignant' && u.actif).length;
            const absencesAujourdhui = SCOLARIS_DATA.absences.filter(a => a.date === new Date().toISOString().split('T')[0]).length;
            const sanctionsActives = (SCOLARIS_DATA.sanctions || []).filter(s => s.statut === 'active').length;
            
            let contenu = '';
            
            if (utilisateurCourant.role === 'admin_systeme' || utilisateurCourant.role === 'proviseur') {
                contenu = `
                    <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Tableau de bord</h1>
                    
                    <div class="cards-container">
                        <div class="card">
                            <div class="card-title"><i class="fas fa-user-graduate"></i> Élèves inscrits</div>
                            <div class="card-value">${totalEleves}</div>
                            <div class="card-subtitle">Total de l'établissement</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-users"></i> Classes</div>
                            <div class="card-value">${totalClasses}</div>
                            <div class="card-subtitle">Classes actives</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-chalkboard-teacher"></i> Enseignants</div>
                            <div class="card-value">${totalEnseignants}</div>
                            <div class="card-subtitle">Personnel enseignant</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-user-clock"></i> Absences aujourd'hui</div>
                            <div class="card-value">${absencesAujourdhui}</div>
                            <div class="card-subtitle">Élèves absents</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <div class="table-container">
                                <div class="table-header">
                                    <div class="table-title">Dernières activités</div>
                                </div>
                                <div class="table-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Description</th>
                                                <th>Utilisateur</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>${new Date().toLocaleDateString('fr-FR')}</td>
                                                <td><span class="badge badge-success">Connexion</span></td>
                                                <td>Vous êtes connecté(e)</td>
                                                <td>${utilisateurCourant.prenom} ${utilisateurCourant.nom}</td>
                                            </tr>
                                            ${totalEleves === 0 ? `
                                            <tr>
                                                <td>Aujourd'hui</td>
                                                <td><span class="badge badge-warning">Action</span></td>
                                                <td>Ajoutez vos premiers élèves</td>
                                                <td>Système</td>
                                            </tr>` : ''}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <div class="table-container">
                                <div class="table-header">
                                    <div class="table-title">Actions rapides</div>
                                </div>
                                <div class="table-content" style="padding: 15px;">
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <button class="btn btn-primary" onclick="afficherGestionUtilisateurs()">
                                            <i class="fas fa-user-plus"></i> Ajouter un utilisateur
                                        </button>
                                        <button class="btn btn-primary" onclick="afficherGestionEleves()">
                                            <i class="fas fa-user-graduate"></i> Inscrire un élève
                                        </button>
                                        <button class="btn btn-primary" onclick="afficherGestionEnseignants()">
                                            <i class="fas fa-chalkboard-teacher"></i> Ajouter un enseignant
                                        </button>
                                        <button class="btn btn-secondary" onclick="afficherParametres()">
                                            <i class="fas fa-cog"></i> Paramètres
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (utilisateurCourant.role === 'enseignant') {
                const mesClasses = SCOLARIS_DATA.classes.filter(c => 
                    c.prof_principal_id === utilisateurCourant.id ||
                    (utilisateurCourant.classes && utilisateurCourant.classes.includes(c.id))
                );
                
                contenu = `
                    <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Tableau de bord Enseignant</h1>
                    
                    <div class="cards-container">
                        <div class="card">
                            <div class="card-title"><i class="fas fa-chalkboard-teacher"></i> Mes classes</div>
                            <div class="card-value">${mesClasses.length}</div>
                            <div class="card-subtitle">Classes assignées</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-user-graduate"></i> Mes élèves</div>
                            <div class="card-value">${mesClasses.reduce((total, classe) => {
                                return total + SCOLARIS_DATA.eleves.filter(e => e.classe_id === classe.id).length;
                            }, 0)}</div>
                            <div class="card-subtitle">Élèves à charge</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-tasks"></i> Devoirs à corriger</div>
                            <div class="card-value">${SCOLARIS_DATA.devoirs.filter(d => 
                                d.professeur_id === utilisateurCourant.id && 
                                d.statut === 'à_corriger').length}</div>
                            <div class="card-subtitle">En attente</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-calendar-alt"></i> Cours aujourd'hui</div>
                            <div class="card-value">${(SCOLARIS_DATA.emploi_du_temps || []).filter(edt => 
                                edt.professeur_id === utilisateurCourant.id && 
                                edt.date === new Date().toISOString().split('T')[0]).length}</div>
                            <div class="card-subtitle">Séances</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <div class="table-container">
                                <div class="table-header">
                                    <div class="table-title">Mes prochains cours</div>
                                </div>
                                <div class="table-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Heure</th>
                                                <th>Classe</th>
                                                <th>Matière</th>
                                                <th>Salle</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(SCOLARIS_DATA.emploi_du_temps || [])
                                                .filter(edt => edt.professeur_id === utilisateurCourant.id)
                                                .sort((a, b) => new Date(a.date + ' ' + a.heure_debut) - new Date(b.date + ' ' + b.heure_debut))
                                                .slice(0, 5)
                                                .map(edt => {
                                                    const classe = SCOLARIS_DATA.classes.find(c => c.id === edt.classe_id);
                                                    const matiere = SCOLARIS_DATA.matieres.find(m => m.id === edt.matiere_id);
                                                    return `
                                                    <tr>
                                                        <td>${formatDate(edt.date)}</td>
                                                        <td>${edt.heure_debut}</td>
                                                        <td>${classe ? classe.nom : ''}</td>
                                                        <td>${matiere ? matiere.nom : ''}</td>
                                                        <td>${edt.salle || ''}</td>
                                                    </tr>`;
                                                }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (utilisateurCourant.role === 'eleve') {
                const eleveId = utilisateurCourant.eleve_id;
                const eleve = SCOLARIS_DATA.eleves.find(e => e.id === eleveId);
                const classe = eleve ? SCOLARIS_DATA.classes.find(c => c.id === eleve.classe_id) : null;
                const notes = SCOLARIS_DATA.notes.filter(n => n.eleve_id === eleveId);
                const moyenne = notes.length > 0 ? 
                    (notes.reduce((sum, n) => sum + n.valeur, 0) / notes.length).toFixed(2) : 'N/A';
                
                contenu = `
                    <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Mon tableau de bord</h1>
                    
                    <div class="cards-container">
                        <div class="card">
                            <div class="card-title"><i class="fas fa-graduation-cap"></i> Ma moyenne</div>
                            <div class="card-value">${moyenne}/20</div>
                            <div class="card-subtitle">${notes.length} notes</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-user-clock"></i> Mes absences</div>
                            <div class="card-value">${SCOLARIS_DATA.absences.filter(a => a.eleve_id === eleveId).length}</div>
                            <div class="card-subtitle">Cette année</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-tasks"></i> Mes devoirs</div>
                            <div class="card-value">${SCOLARIS_DATA.devoirs.filter(d => 
                                d.classe_id === eleve.classe_id && d.statut === 'à_rendre').length}</div>
                            <div class="card-subtitle">À rendre</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-sticky-note"></i> Mes observations</div>
                            <div class="card-value">${(SCOLARIS_DATA.observations || []).filter(o => 
                                o.eleve_id === eleveId && o.visible_eleve !== false).length}</div>
                            <div class="card-subtitle">Récentes</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <div class="table-container">
                                <div class="table-header">
                                    <div class="table-title">Mes prochains devoirs</div>
                                </div>
                                <div class="table-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Matière</th>
                                                <th>Titre</th>
                                                <th>À rendre pour le</th>
                                                <th>Statut</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${SCOLARIS_DATA.devoirs
                                                .filter(d => d.classe_id === eleve.classe_id && d.statut === 'à_rendre')
                                                .sort((a, b) => new Date(a.date_rendu) - new Date(b.date_rendu))
                                                .slice(0, 5)
                                                .map(devoir => {
                                                    const matiere = SCOLARIS_DATA.matieres.find(m => m.id === devoir.matiere_id);
                                                    return `
                                                    <tr>
                                                        <td>${matiere ? matiere.nom : 'Inconnu'}</td>
                                                        <td>${devoir.titre}</td>
                                                        <td>${formatDate(devoir.date_rendu)}</td>
                                                        <td><span class="badge badge-warning">À rendre</span></td>
                                                    </tr>`;
                                                }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <div class="table-container">
                                <div class="table-header">
                                    <div class="table-title">Mes cours aujourd'hui</div>
                                </div>
                                <div class="table-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Heure</th>
                                                <th>Matière</th>
                                                <th>Salle</th>
                                                <th>Professeur</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(SCOLARIS_DATA.emploi_du_temps || [])
                                                .filter(edt => edt.classe_id === eleve.classe_id && 
                                                       edt.date === new Date().toISOString().split('T')[0])
                                                .sort((a, b) => a.heure_debut.localeCompare(b.heure_debut))
                                                .map(edt => {
                                                    const matiere = SCOLARIS_DATA.matieres.find(m => m.id === edt.matiere_id);
                                                    const professeur = SCOLARIS_DATA.utilisateurs.find(u => u.id === edt.professeur_id);
                                                    return `
                                                    <tr>
                                                        <td>${edt.heure_debut} - ${edt.heure_fin}</td>
                                                        <td>${matiere ? matiere.nom : ''}</td>
                                                        <td>${edt.salle || ''}</td>
                                                        <td>${professeur ? professeur.prenom + ' ' + professeur.nom : ''}</td>
                                                    </tr>`;
                                                }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (utilisateurCourant.role === 'parent') {
                const enfants = SCOLARIS_DATA.eleves.filter(e => 
                    e.responsable_1 === utilisateurCourant.nom || 
                    e.email_responsable_1 === utilisateurCourant.email
                );
                
                contenu = `
                    <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Tableau de bord Parent</h1>
                    
                    <div class="cards-container">
                        <div class="card">
                            <div class="card-title"><i class="fas fa-child"></i> Mes enfants</div>
                            <div class="card-value">${enfants.length}</div>
                            <div class="card-subtitle">Inscrits</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-graduation-cap"></i> Moyenne générale</div>
                            <div class="card-value">14.2/20</div>
                            <div class="card-subtitle">Moyenne famille</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-user-clock"></i> Absences totales</div>
                            <div class="card-value">${enfants.reduce((total, enfant) => {
                                return total + SCOLARIS_DATA.absences.filter(a => a.eleve_id === enfant.id).length;
                            }, 0)}</div>
                            <div class="card-subtitle">Cette année</div>
                        </div>
                        <div class="card">
                            <div class="card-title"><i class="fas fa-envelope"></i> Messages non lus</div>
                            <div class="card-value">${(SCOLARIS_DATA.messages || []).filter(m => 
                                m.destinataire_id === utilisateurCourant.id && 
                                m.lu === false).length}</div>
                            <div class="card-subtitle">En attente</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <div class="table-container">
                                <div class="table-header">
                                    <div class="table-title">Mes enfants</div>
                                </div>
                                <div class="table-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Nom</th>
                                                <th>Prénom</th>
                                                <th>Classe</th>
                                                <th>Moyenne</th>
                                                <th>Absences</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${enfants.map(enfant => {
                                                const classe = SCOLARIS_DATA.classes.find(c => c.id === enfant.classe_id);
                                                const notes = SCOLARIS_DATA.notes.filter(n => n.eleve_id === enfant.id);
                                                const moyenne = notes.length > 0 ? 
                                                    (notes.reduce((sum, n) => sum + n.valeur, 0) / notes.length).toFixed(1) : 'N/A';
                                                const absences = SCOLARIS_DATA.absences.filter(a => a.eleve_id === enfant.id).length;
                                                return `
                                                <tr>
                                                    <td>${enfant.nom}</td>
                                                    <td>${enfant.prenom}</td>
                                                    <td>${classe ? classe.nom : ''}</td>
                                                    <td><strong>${moyenne}/20</strong></td>
                                                    <td>${absences}</td>
                                                    <td>
                                                        <button class="btn btn-secondary btn-small" onclick="voirFicheEleveParent(${enfant.id})">
                                                            <i class="fas fa-eye"></i> Voir
                                                        </button>
                                                    </td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            document.getElementById('contenuPrincipal').innerHTML = contenu + `
                <div class="mention-legale">
                    <i class="fas fa-exclamation-circle"></i>
                    Cette plateforme est une simulation fictive à usage pédagogique.
                </div>`;
            
            setActiveMenu('dashboard');
        }

        // ============================================
        // GESTION DES UTILISATEURS
        // ============================================
        function afficherGestionUtilisateurs() {
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Gestion des utilisateurs</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelUtilisateur()">
                        <i class="fas fa-user-plus"></i> Nouvel utilisateur
                    </button>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Utilisateurs du système (${SCOLARIS_DATA.utilisateurs.length})</div>
                    </div>
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Rôle</th>
                                    <th>Identifiant</th>
                                    <th>Email</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${SCOLARIS_DATA.utilisateurs.map(utilisateur => {
                                    const role = SCOLARIS_DATA.roles.find(r => r.id === utilisateur.role);
                                    return `
                                    <tr>
                                        <td>${utilisateur.id}</td>
                                        <td>${utilisateur.nom}</td>
                                        <td>${utilisateur.prenom}</td>
                                        <td>${role ? role.nom : utilisateur.role}</td>
                                        <td>${utilisateur.identifiant}</td>
                                        <td>${utilisateur.email || ''}</td>
                                        <td>${utilisateur.actif ? 
                                            '<span class="badge badge-success">Actif</span>' : 
                                            '<span class="badge badge-danger">Inactif</span>'}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-secondary btn-small" onclick="modifierUtilisateur(${utilisateur.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                ${utilisateur.id !== 1 ? `
                                                <button class="btn btn-danger btn-small" onclick="supprimerUtilisateur(${utilisateur.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>` : ''}
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            setActiveMenu('utilisateurs');
        }

        function ouvrirModalNouvelUtilisateur() {
            const modalHtml = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">👤 Ajouter un nouvel utilisateur</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouvelUtilisateur">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom *</label>
                                    <input type="text" class="form-control" id="nouveauNom" required>
                                </div>
                                <div class="form-group">
                                    <label>Prénom *</label>
                                    <input type="text" class="form-control" id="nouveauPrenom" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Rôle *</label>
                                    <select class="form-control" id="nouveauRole" required>
                                        <option value="">Sélectionner un rôle</option>
                                        ${SCOLARIS_DATA.roles.map(role => 
                                            `<option value="${role.id}">${role.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Identifiant *</label>
                                    <input type="text" class="form-control" id="nouveauIdentifiant" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Mot de passe *</label>
                                    <input type="password" class="form-control" id="nouveauPassword" value="password123" required>
                                </div>
                                <div class="form-group">
                                    <label>Confirmer le mot de passe *</label>
                                    <input type="password" class="form-control" id="nouveauPasswordConfirm" value="password123" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" id="nouveauEmail">
                                </div>
                                <div class="form-group">
                                    <label>Téléphone</label>
                                    <input type="tel" class="form-control" id="nouveauTelephone">
                                </div>
                            </div>
                            <div id="champsEnseignant" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Matières enseignées</label>
                                        <select class="form-control" id="nouveauMatieres" multiple style="height: 100px;">
                                            ${SCOLARIS_DATA.matieres.map(matiere => 
                                                `<option value="${matiere.id}">${matiere.nom}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouvelUtilisateur()">
                            <i class="fas fa-save"></i> Créer l'utilisateur
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
            
            document.getElementById('nouveauRole').addEventListener('change', function() {
                const champsEnseignant = document.getElementById('champsEnseignant');
                champsEnseignant.style.display = this.value === 'enseignant' ? 'block' : 'none';
            });
        }

        async function creerNouvelUtilisateur() {
            const nom = document.getElementById('nouveauNom').value;
            const prenom = document.getElementById('nouveauPrenom').value;
            const role = document.getElementById('nouveauRole').value;
            const identifiant = document.getElementById('nouveauIdentifiant').value;
            const password = document.getElementById('nouveauPassword').value;
            const passwordConfirm = document.getElementById('nouveauPasswordConfirm').value;
            
            if (!nom || !prenom || !role || !identifiant || !password) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            if (password !== passwordConfirm) {
                alert('Les mots de passe ne correspondent pas');
                return;
            }
            
            if (SCOLARIS_DATA.utilisateurs.find(u => u.identifiant === identifiant)) {
                alert('Cet identifiant est déjà utilisé');
                return;
            }
            
            const nouvelId = Math.max(...SCOLARIS_DATA.utilisateurs.map(u => u.id), 0) + 1;
            const nouvelUtilisateur = {
                id: nouvelId,
                nom: nom,
                prenom: prenom,
                role: role,
                identifiant: identifiant,
                password: password,
                email: document.getElementById('nouveauEmail').value,
                telephone: document.getElementById('nouveauTelephone').value,
                date_creation: new Date().toISOString().split('T')[0],
                actif: true
            };
            
            if (role === 'enseignant') {
                const matieresSelect = document.getElementById('nouveauMatieres');
                const matieresSelectionnees = Array.from(matieresSelect.selectedOptions).map(opt => parseInt(opt.value));
                nouvelUtilisateur.matieres = matieresSelectionnees;
                nouvelUtilisateur.classes = [];
            }
            
            SCOLARIS_DATA.utilisateurs.push(nouvelUtilisateur);
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert(`Utilisateur créé avec succès !\n\nIdentifiant: ${identifiant}\nMot de passe: ${password}`);
                fermerModal();
                afficherGestionUtilisateurs();
            } else {
                alert('Erreur lors de la création: ' + result.error);
            }
        }

        // ============================================
        // GESTION DES ÉLÈVES
        // ============================================
        function afficherGestionEleves() {
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Gestion des élèves</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelEleve()">
                        <i class="fas fa-user-plus"></i> Nouvel élève
                    </button>
                </div>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Rechercher un élève..." 
                               onkeyup="rechercherEleves(this.value)">
                    </div>
                    <div class="form-group" style="width: 200px;">
                        <select class="form-control" onchange="filtrerElevesParClasse(this.value)">
                            <option value="">Toutes les classes</option>
                            ${SCOLARIS_DATA.classes.map(classe => 
                                `<option value="${classe.id}">${classe.nom}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Élèves inscrits (${SCOLARIS_DATA.eleves.length})</div>
                    </div>
                    <div class="table-content">
                        <table id="tableEleves">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Classe</th>
                                    <th>Date de naissance</th>
                                    <th>Responsable</th>
                                    <th>Téléphone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${SCOLARIS_DATA.eleves.map(eleve => {
                                    const classe = SCOLARIS_DATA.classes.find(c => c.id === eleve.classe_id);
                                    return `
                                    <tr data-eleve-id="${eleve.id}">
                                        <td><strong>${eleve.nom}</strong></td>
                                        <td>${eleve.prenom}</td>
                                        <td>${classe ? classe.nom : 'Non affecté'}</td>
                                        <td>${formatDate(eleve.date_naissance)}</td>
                                        <td>${eleve.responsable_1 || ''}</td>
                                        <td>${eleve.tel_responsable_1 || ''}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-secondary btn-small" onclick="voirFicheEleve(${eleve.id})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-secondary btn-small" onclick="modifierEleve(${eleve.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-small" onclick="supprimerEleve(${eleve.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                ${SCOLARIS_DATA.eleves.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-user-graduate" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucun élève enregistré</h3>
                    <p style="color: #888; margin-bottom: 25px;">Commencez par inscrire vos premiers élèves.</p>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelEleve()">
                        <i class="fas fa-user-plus"></i> Inscrire le premier élève
                    </button>
                </div>` : ''}`;
            
            setActiveMenu('eleves');
        }

        function ouvrirModalNouvelEleve() {
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">👤 Inscrire un nouvel élève</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouvelEleve">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom *</label>
                                    <input type="text" class="form-control" id="eleveNom" required>
                                </div>
                                <div class="form-group">
                                    <label>Prénom *</label>
                                    <input type="text" class="form-control" id="elevePrenom" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date de naissance *</label>
                                    <input type="date" class="form-control" id="eleveNaissance" required>
                                </div>
                                <div class="form-group">
                                    <label>Classe *</label>
                                    <select class="form-control" id="eleveClasse" required>
                                        <option value="">Sélectionner une classe</option>
                                        ${SCOLARIS_DATA.classes.map(classe => 
                                            `<option value="${classe.id}">${classe.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <h4 style="color: var(--couleur-principale); margin: 25px 0 15px 0;">Responsable légal 1</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom du responsable *</label>
                                    <input type="text" class="form-control" id="eleveResponsable1" required>
                                </div>
                                <div class="form-group">
                                    <label>Téléphone *</label>
                                    <input type="tel" class="form-control" id="eleveTel1" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" id="eleveEmail1">
                                </div>
                                <div class="form-group">
                                    <label>Lien de parenté</label>
                                    <select class="form-control" id="eleveParente1">
                                        <option value="Mère">Mère</option>
                                        <option value="Père">Père</option>
                                        <option value="Tuteur">Tuteur</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                            </div>
                            <h4 style="color: var(--couleur-principale); margin: 25px 0 15px 0;">Informations complémentaires</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Adresse</label>
                                    <input type="text" class="form-control" id="eleveAdresse">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Code postal</label>
                                    <input type="text" class="form-control" id="eleveCP">
                                </div>
                                <div class="form-group">
                                    <label>Ville</label>
                                    <input type="text" class="form-control" id="eleveVille">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Informations médicales</label>
                                    <textarea class="form-control" id="eleveMedical" rows="3" placeholder="Allergies, traitements..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouvelEleve()">
                            <i class="fas fa-save"></i> Inscrire l'élève
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        async function creerNouvelEleve() {
            const nom = document.getElementById('eleveNom').value;
            const prenom = document.getElementById('elevePrenom').value;
            const naissance = document.getElementById('eleveNaissance').value;
            const classeId = parseInt(document.getElementById('eleveClasse').value);
            const responsable1 = document.getElementById('eleveResponsable1').value;
            const tel1 = document.getElementById('eleveTel1').value;
            
            if (!nom || !prenom || !naissance || !classeId || !responsable1 || !tel1) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            const classe = SCOLARIS_DATA.classes.find(c => c.id === classeId);
            if (!classe) {
                alert('Classe sélectionnée invalide');
                return;
            }
            
            const nouvelId = Math.max(...SCOLARIS_DATA.eleves.map(e => e.id), 0) + 1;
            const nouvelEleve = {
                id: nouvelId,
                nom: nom,
                prenom: prenom,
                classe: classe.nom,
                classe_id: classeId,
                date_naissance: naissance,
                responsable_1: responsable1,
                tel_responsable_1: tel1,
                email_responsable_1: document.getElementById('eleveEmail1').value,
                parente_responsable_1: document.getElementById('eleveParente1').value,
                adresse: document.getElementById('eleveAdresse').value,
                code_postal: document.getElementById('eleveCP').value,
                ville: document.getElementById('eleveVille').value,
                informations_medicales: document.getElementById('eleveMedical').value,
                date_inscription: new Date().toISOString().split('T')[0],
                statut: 'inscrit'
            };
            
            SCOLARIS_DATA.eleves.push(nouvelEleve);
            
            // Créer automatiquement un compte élève
            const nouvelUtilisateurId = Math.max(...SCOLARIS_DATA.utilisateurs.map(u => u.id), 0) + 1;
            const nouvelUtilisateur = {
                id: nouvelUtilisateurId,
                nom: nom,
                prenom: prenom,
                role: 'eleve',
                identifiant: `${prenom.toLowerCase()}.${nom.toLowerCase().substring(0, 3)}`,
                password: 'eleve123',
                email: `${prenom.toLowerCase()}.${nom.toLowerCase()}@edu.fr`,
                date_creation: new Date().toISOString().split('T')[0],
                actif: true,
                eleve_id: nouvelId
            };
            
            SCOLARIS_DATA.utilisateurs.push(nouvelUtilisateur);
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert(`Élève inscrit avec succès !\n\nUn compte a été créé automatiquement :\nIdentifiant: ${nouvelUtilisateur.identifiant}\nMot de passe: eleve123`);
                fermerModal();
                afficherGestionEleves();
            } else {
                alert('Erreur lors de l\'inscription: ' + result.error);
            }
        }

        function voirFicheEleve(eleveId) {
            const eleve = SCOLARIS_DATA.eleves.find(e => e.id === eleveId);
            if (!eleve) return;
            
            const classe = SCOLARIS_DATA.classes.find(c => c.id === eleve.classe_id);
            const notesEleve = SCOLARIS_DATA.notes.filter(n => n.eleve_id === eleveId);
            const absencesEleve = SCOLARIS_DATA.absences.filter(a => a.eleve_id === eleveId);
            const sanctionsEleve = (SCOLARIS_DATA.sanctions || []).filter(s => s.eleve_id === eleveId);
            const observationsEleve = (SCOLARIS_DATA.observations || []).filter(o => o.eleve_id === eleveId);
            
            const modalHtml = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <div class="modal-title">📄 Fiche élève : ${eleve.nom} ${eleve.prenom}</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: flex; gap: 30px; margin-bottom: 25px;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Identité</h4>
                                <p><strong>Nom :</strong> ${eleve.nom}</p>
                                <p><strong>Prénom :</strong> ${eleve.prenom}</p>
                                <p><strong>Date de naissance :</strong> ${formatDate(eleve.date_naissance)}</p>
                                <p><strong>Classe :</strong> ${classe ? classe.nom : 'Non affecté'}</p>
                                <p><strong>Date d'inscription :</strong> ${formatDate(eleve.date_inscription)}</p>
                                <p><strong>Statut :</strong> ${eleve.statut || 'Inscrit'}</p>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Responsables légaux</h4>
                                <p><strong>Responsable 1 :</strong> ${eleve.responsable_1}</p>
                                <p><strong>Téléphone :</strong> ${eleve.tel_responsable_1}</p>
                                <p><strong>Email :</strong> ${eleve.email_responsable_1 || 'Non renseigné'}</p>
                                <p><strong>Lien de parenté :</strong> ${eleve.parente_responsable_1 || 'Non renseigné'}</p>
                            </div>
                        </div>
                        
                        ${eleve.informations_medicales ? `
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h4 style="color: var(--couleur-principale); margin-bottom: 10px;"><i class="fas fa-heartbeat"></i> Informations médicales</h4>
                            <p>${eleve.informations_medicales}</p>
                        </div>` : ''}
                        
                        <div style="display: flex; gap: 30px; margin-bottom: 20px;">
                            <div>
                                <h4 style="color: var(--couleur-principale); margin-bottom: 10px;">Scolarité</h4>
                                <p><strong>Notes enregistrées :</strong> ${notesEleve.length}</p>
                                <p><strong>Absences cette année :</strong> ${absencesEleve.length}</p>
                                <p><strong>Retards :</strong> ${SCOLARIS_DATA.retards.filter(r => r.eleve_id === eleveId).length}</p>
                                <p><strong>Sanctions actives :</strong> ${sanctionsEleve.filter(s => s.statut === 'active').length}</p>
                                <p><strong>Observations :</strong> ${observationsEleve.length}</p>
                            </div>
                            <div>
                                <h4 style="color: var(--couleur-principale); margin-bottom: 10px;">Coordonnées</h4>
                                <p><strong>Adresse :</strong> ${eleve.adresse || 'Non renseignée'}</p>
                                <p><strong>Ville :</strong> ${eleve.ville || ''} ${eleve.code_postal || ''}</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Actions</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="genererFicheElevePDF(${eleveId})">
                                    <i class="fas fa-print"></i> Imprimer la fiche
                                </button>
                                <button class="btn btn-secondary" onclick="modifierEleve(${eleveId})">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button class="btn btn-secondary" onclick="voirNotesEleve(${eleveId})">
                                    <i class="fas fa-graduation-cap"></i> Voir les notes
                                </button>
                                <button class="btn btn-secondary" onclick="ajouterObservationEleve(${eleveId})">
                                    <i class="fas fa-sticky-note"></i> Ajouter une observation
                                </button>
                                <button class="btn btn-warning" onclick="ajouterSanctionEleve(${eleveId})">
                                    <i class="fas fa-gavel"></i> Ajouter une sanction
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Fermer</button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        function modifierEleve(eleveId) {
            const eleve = SCOLARIS_DATA.eleves.find(e => e.id === eleveId);
            if (!eleve) return;
            
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">✏️ Modifier l'élève</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formModifierEleve">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom *</label>
                                    <input type="text" class="form-control" id="modifEleveNom" value="${eleve.nom}" required>
                                </div>
                                <div class="form-group">
                                    <label>Prénom *</label>
                                    <input type="text" class="form-control" id="modifElevePrenom" value="${eleve.prenom}" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date de naissance *</label>
                                    <input type="date" class="form-control" id="modifEleveNaissance" value="${eleve.date_naissance}" required>
                                </div>
                                <div class="form-group">
                                    <label>Classe *</label>
                                    <select class="form-control" id="modifEleveClasse" required>
                                        ${SCOLARIS_DATA.classes.map(classe => 
                                            `<option value="${classe.id}" ${eleve.classe_id === classe.id ? 'selected' : ''}>${classe.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Statut</label>
                                    <select class="form-control" id="modifEleveStatut">
                                        <option value="inscrit" ${eleve.statut === 'inscrit' ? 'selected' : ''}>Inscrit</option>
                                        <option value="radie" ${eleve.statut === 'radie' ? 'selected' : ''}>Radié</option>
                                        <option value="exclu" ${eleve.statut === 'exclu' ? 'selected' : ''}>Exclu</option>
                                        <option value="demenage" ${eleve.statut === 'demenage' ? 'selected' : ''}>Déménagé</option>
                                    </select>
                                </div>
                            </div>
                            <h4 style="color: var(--couleur-principale); margin: 25px 0 15px 0;">Responsable légal 1</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom du responsable *</label>
                                    <input type="text" class="form-control" id="modifEleveResponsable1" value="${eleve.responsable_1}" required>
                                </div>
                                <div class="form-group">
                                    <label>Téléphone *</label>
                                    <input type="tel" class="form-control" id="modifEleveTel1" value="${eleve.tel_responsable_1}" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" id="modifEleveEmail1" value="${eleve.email_responsable_1 || ''}">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="sauvegarderModificationEleve(${eleveId})">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        async function sauvegarderModificationEleve(eleveId) {
            const eleveIndex = SCOLARIS_DATA.eleves.findIndex(e => e.id === eleveId);
            if (eleveIndex === -1) return;
            
            const eleve = SCOLARIS_DATA.eleves[eleveIndex];
            const nouvelleClasseId = parseInt(document.getElementById('modifEleveClasse').value);
            const nouvelleClasse = SCOLARIS_DATA.classes.find(c => c.id === nouvelleClasseId);
            
            eleve.nom = document.getElementById('modifEleveNom').value;
            eleve.prenom = document.getElementById('modifElevePrenom').value;
            eleve.date_naissance = document.getElementById('modifEleveNaissance').value;
            eleve.classe_id = nouvelleClasseId;
            eleve.classe = nouvelleClasse ? nouvelleClasse.nom : eleve.classe;
            eleve.statut = document.getElementById('modifEleveStatut').value;
            eleve.responsable_1 = document.getElementById('modifEleveResponsable1').value;
            eleve.tel_responsable_1 = document.getElementById('modifEleveTel1').value;
            eleve.email_responsable_1 = document.getElementById('modifEleveEmail1').value;
            
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Élève modifié avec succès !');
                fermerModal();
                afficherGestionEleves();
            } else {
                alert('Erreur lors de la modification: ' + result.error);
            }
        }

        async function supprimerEleve(eleveId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cet élève ? Cette action supprimera également toutes ses notes et absences.')) {
                return;
            }
            
            // Supprimer l'élève
            SCOLARIS_DATA.eleves = SCOLARIS_DATA.eleves.filter(e => e.id !== eleveId);
            
            // Supprimer les notes de l'élève
            SCOLARIS_DATA.notes = SCOLARIS_DATA.notes.filter(n => n.eleve_id !== eleveId);
            
            // Supprimer les absences de l'élève
            SCOLARIS_DATA.absences = SCOLARIS_DATA.absences.filter(a => a.eleve_id !== eleveId);
            
            // Supprimer les retards de l'élève
            SCOLARIS_DATA.retards = SCOLARIS_DATA.retards.filter(r => r.eleve_id !== eleveId);
            
            // Supprimer les sanctions de l'élève
            if (SCOLARIS_DATA.sanctions) {
                SCOLARIS_DATA.sanctions = SCOLARIS_DATA.sanctions.filter(s => s.eleve_id !== eleveId);
            }
            
            // Supprimer les observations de l'élève
            if (SCOLARIS_DATA.observations) {
                SCOLARIS_DATA.observations = SCOLARIS_DATA.observations.filter(o => o.eleve_id !== eleveId);
            }
            
            // Supprimer le compte utilisateur associé
            SCOLARIS_DATA.utilisateurs = SCOLARIS_DATA.utilisateurs.filter(u => u.eleve_id !== eleveId);
            
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Élève supprimé avec succès !');
                afficherGestionEleves();
            } else {
                alert('Erreur lors de la suppression: ' + result.error);
            }
        }

        // ============================================
        // GESTION DES CLASSES
        // ============================================
        function afficherGestionClasses() {
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Gestion des classes</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelleClasse()">
                        <i class="fas fa-plus"></i> Nouvelle classe
                    </button>
                </div>
                
                <div class="cards-container" style="margin-bottom: 30px;">
                    <div class="card">
                        <div class="card-title">Classes actives</div>
                        <div class="card-value">${SCOLARIS_DATA.classes.length}</div>
                        <div class="card-subtitle">Total de l'établissement</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Effectif total</div>
                        <div class="card-value">${SCOLARIS_DATA.eleves.length}</div>
                        <div class="card-subtitle">Élèves inscrits</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Moyenne par classe</div>
                        <div class="card-value">${SCOLARIS_DATA.classes.length > 0 ? Math.round(SCOLARIS_DATA.eleves.length / SCOLARIS_DATA.classes.length) : 0}</div>
                        <div class="card-subtitle">Élèves par classe</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Liste des classes</div>
                    </div>
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Classe</th>
                                    <th>Niveau</th>
                                    <th>Professeur principal</th>
                                    <th>Effectif</th>
                                    <th>Salle</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${SCOLARIS_DATA.classes.map(classe => {
                                    const effectif = SCOLARIS_DATA.eleves.filter(e => e.classe_id === classe.id).length;
                                    const profPrincipal = classe.prof_principal_id ?
                                        SCOLARIS_DATA.utilisateurs.find(u => u.id === classe.prof_principal_id) : null;
                                    return `
                                    <tr>
                                        <td><strong>${classe.nom}</strong></td>
                                        <td>${classe.niveau}</td>
                                        <td>${profPrincipal ? profPrincipal.prenom + ' ' + profPrincipal.nom : 'Non attribué'}</td>
                                        <td>${effectif} / ${classe.effectif_max || 30}</td>
                                        <td>${classe.salle || ''}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-secondary btn-small" onclick="voirDetailsClasse('${classe.id}')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-secondary btn-small" onclick="modifierClasse('${classe.id}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-small" onclick="supprimerClasse('${classe.id}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                ${SCOLARIS_DATA.classes.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-users" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucune classe créée</h3>
                    <p style="color: #888; margin-bottom: 25px;">Commencez par créer vos premières classes.</p>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelleClasse()">
                        <i class="fas fa-plus"></i> Créer la première classe
                    </button>
                </div>` : ''}`;
            
            setActiveMenu('classes');
        }

        function ouvrirModalNouvelleClasse() {
            const modalHtml = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">🏫 Créer une nouvelle classe</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouvelleClasse">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom de la classe *</label>
                                    <input type="text" class="form-control" id="classeNom" placeholder="Ex: 6ème A" required>
                                </div>
                                <div class="form-group">
                                    <label>Niveau *</label>
                                    <select class="form-control" id="classeNiveau" required>
                                        <option value="">Sélectionner</option>
                                        <option value="6ème">6ème</option>
                                        <option value="5ème">5ème</option>
                                        <option value="4ème">4ème</option>
                                        <option value="3ème">3ème</option>
                                        <option value="2nde">2nde</option>
                                        <option value="1ère">1ère</option>
                                        <option value="Terminale">Terminale</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Professeur principal</label>
                                    <select class="form-control" id="classeProfPrincipal">
                                        <option value="">Non attribué</option>
                                        ${SCOLARIS_DATA.utilisateurs
                                            .filter(u => u.role === 'enseignant' && u.actif)
                                            .map(prof => `<option value="${prof.id}">${prof.prenom} ${prof.nom}</option>`)
                                            .join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Effectif maximum</label>
                                    <input type="number" class="form-control" id="classeEffectifMax" value="30" min="1" max="35">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Salle attribuée</label>
                                    <input type="text" class="form-control" id="classeSalle" placeholder="Ex: Salle 201">
                                </div>
                                <div class="form-group">
                                    <label>Heure de rentrée</label>
                                    <input type="time" class="form-control" id="classeHeureRentree" value="08:30">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouvelleClasse()">
                            <i class="fas fa-save"></i> Créer la classe
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        async function creerNouvelleClasse() {
            const nom = document.getElementById('classeNom').value;
            const niveau = document.getElementById('classeNiveau').value;
            const profId = document.getElementById('classeProfPrincipal').value;
            const effectifMax = parseInt(document.getElementById('classeEffectifMax').value);
            const salle = document.getElementById('classeSalle').value;
            const heureRentree = document.getElementById('classeHeureRentree').value;
            
            if (!nom || !niveau) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            // Vérifier si la classe existe déjà
            if (SCOLARIS_DATA.classes.find(c => c.nom === nom)) {
                alert('Une classe avec ce nom existe déjà');
                return;
            }
            
            const id = 'classe_' + Date.now();
            const profPrincipal = profId ?
                SCOLARIS_DATA.utilisateurs.find(u => u.id === parseInt(profId)) : null;
            
            const nouvelleClasse = {
                id: id,
                nom: nom,
                niveau: niveau,
                prof_principal_id: profId ? parseInt(profId) : null,
                prof_principal: profPrincipal ? profPrincipal.prenom + ' ' + profPrincipal.nom : 'Non attribué',
                effectif_max: effectifMax,
                salle: salle,
                heure_rentree: heureRentree,
                created_at: new Date().toISOString().split('T')[0]
            };
            
            SCOLARIS_DATA.classes.push(nouvelleClasse);
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Classe créée avec succès !');
                fermerModal();
                afficherGestionClasses();
            } else {
                alert('Erreur lors de la création: ' + result.error);
            }
        }

        function voirDetailsClasse(classeId) {
            const classe = SCOLARIS_DATA.classes.find(c => c.id === classeId);
            if (!classe) return;
            
            const elevesClasse = SCOLARIS_DATA.eleves.filter(e => e.classe_id === classeId);
            const profPrincipal = classe.prof_principal_id ?
                SCOLARIS_DATA.utilisateurs.find(u => u.id === classe.prof_principal_id) : null;
            
            const modalHtml = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <div class="modal-title">📊 Détails de la classe : ${classe.nom}</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: flex; gap: 30px; margin-bottom: 25px;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Informations</h4>
                                <p><strong>Niveau :</strong> ${classe.niveau}</p>
                                <p><strong>Professeur principal :</strong> ${classe.prof_principal}</p>
                                <p><strong>Salle :</strong> ${classe.salle || 'Non attribuée'}</p>
                                <p><strong>Heure de rentrée :</strong> ${classe.heure_rentree || '08:30'}</p>
                                <p><strong>Effectif :</strong> ${elevesClasse.length} / ${classe.effectif_max || 30} élèves</p>
                                <p><strong>Date de création :</strong> ${formatDate(classe.created_at)}</p>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Statistiques</h4>
                                <p><strong>Moyenne générale :</strong> 12.8/20</p>
                                <p><strong>Taux d'absentéisme :</strong> 2.1%</p>
                                <p><strong>Retards ce mois :</strong> ${SCOLARIS_DATA.retards.filter(r => 
                                    elevesClasse.find(e => e.id === r.eleve_id)).length}</p>
                                <p><strong>Sanctions actives :</strong> ${(SCOLARIS_DATA.sanctions || []).filter(s => 
                                    elevesClasse.find(e => e.id === s.eleve_id) && s.statut === 'active').length}</p>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Liste des élèves (${elevesClasse.length})</h4>
                        <div class="table-content" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Prénom</th>
                                        <th>Date de naissance</th>
                                        <th>Responsable</th>
                                        <th>Téléphone</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${elevesClasse.map(eleve => `
                                    <tr>
                                        <td>${eleve.nom}</td>
                                        <td>${eleve.prenom}</td>
                                        <td>${formatDate(eleve.date_naissance)}</td>
                                        <td>${eleve.responsable_1}</td>
                                        <td>${eleve.tel_responsable_1}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Actions</h4>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="genererListeClasse('${classeId}')">
                                    <i class="fas fa-print"></i> Imprimer la liste
                                </button>
                                <button class="btn btn-secondary" onclick="modifierClasse('${classeId}')">
                                    <i class="fas fa-edit"></i> Modifier la classe
                                </button>
                                <button class="btn btn-secondary" onclick="affecterElevesClasse('${classeId}')">
                                    <i class="fas fa-user-plus"></i> Affecter des élèves
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Fermer</button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        // ============================================
        // GESTION DES MATIÈRES
        // ============================================
        function afficherGestionMatieres() {
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Gestion des matières</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelleMatiere()">
                        <i class="fas fa-plus"></i> Nouvelle matière
                    </button>
                </div>
                
                <div class="cards-container" style="margin-bottom: 30px;">
                    <div class="card">
                        <div class="card-title">Matières enseignées</div>
                        <div class="card-value">${SCOLARIS_DATA.matieres.length}</div>
                        <div class="card-subtitle">Total de l'établissement</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Coefficient moyen</div>
                        <div class="card-value">${(SCOLARIS_DATA.matieres.reduce((sum, m) => sum + (m.coefficient || 1), 0) / SCOLARIS_DATA.matieres.length).toFixed(1)}</div>
                        <div class="card-subtitle">Moyenne par matière</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Enseignants par matière</div>
                        <div class="card-value">${SCOLARIS_DATA.utilisateurs.filter(u => u.role === 'enseignant').length}</div>
                        <div class="card-subtitle">Personnel enseignant</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Liste des matières</div>
                    </div>
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Matière</th>
                                    <th>Coefficient</th>
                                    <th>Couleur</th>
                                    <th>Enseignants</th>
                                    <th>Heures/semaine</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${SCOLARIS_DATA.matieres.map(matiere => {
                                    const enseignants = SCOLARIS_DATA.utilisateurs
                                        .filter(u => u.role === 'enseignant' && u.matieres && u.matieres.includes(matiere.id))
                                        .map(u => u.prenom + ' ' + u.nom);
                                    return `
                                    <tr>
                                        <td><strong>${matiere.nom}</strong></td>
                                        <td>${matiere.coefficient || 1}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <div style="width: 20px; height: 20px; background-color: ${matiere.couleur || '#3498DB'}; border-radius: 4px;"></div>
                                                ${matiere.couleur || '#3498DB'}
                                            </div>
                                        </td>
                                        <td>${enseignants.length > 0 ? enseignants.join(', ') : 'Non attribué'}</td>
                                        <td>${matiere.heures_semaine || 4}h</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-secondary btn-small" onclick="modifierMatiere(${matiere.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                ${matiere.id > 10 ? `
                                                <button class="btn btn-danger btn-small" onclick="supprimerMatiere(${matiere.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>` : ''}
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            setActiveMenu('matieres');
        }

        function ouvrirModalNouvelleMatiere() {
            const modalHtml = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">📚 Ajouter une nouvelle matière</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouvelleMatiere">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom de la matière *</label>
                                    <input type="text" class="form-control" id="matiereNom" required>
                                </div>
                                <div class="form-group">
                                    <label>Coefficient *</label>
                                    <select class="form-control" id="matiereCoefficient" required>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3" selected>3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Couleur *</label>
                                    <input type="color" class="form-control" id="matiereCouleur" value="#3498DB" required style="height: 40px;">
                                </div>
                                <div class="form-group">
                                    <label>Heures par semaine</label>
                                    <input type="number" class="form-control" id="matiereHeures" value="4" min="1" max="10">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea class="form-control" id="matiereDescription" rows="3"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouvelleMatiere()">
                            <i class="fas fa-save"></i> Créer la matière
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        async function creerNouvelleMatiere() {
            const nom = document.getElementById('matiereNom').value;
            const coefficient = parseInt(document.getElementById('matiereCoefficient').value);
            const couleur = document.getElementById('matiereCouleur').value;
            const heures = parseInt(document.getElementById('matiereHeures').value);
            const description = document.getElementById('matiereDescription').value;
            
            if (!nom) {
                alert('Veuillez remplir le nom de la matière');
                return;
            }
            
            // Vérifier si la matière existe déjà
            if (SCOLARIS_DATA.matieres.find(m => m.nom.toLowerCase() === nom.toLowerCase())) {
                alert('Une matière avec ce nom existe déjà');
                return;
            }
            
            const nouvelId = Math.max(...SCOLARIS_DATA.matieres.map(m => m.id), 0) + 1;
            const nouvelleMatiere = {
                id: nouvelId,
                nom: nom,
                coefficient: coefficient,
                couleur: couleur,
                heures_semaine: heures,
                description: description,
                created_at: new Date().toISOString().split('T')[0]
            };
            
            SCOLARIS_DATA.matieres.push(nouvelleMatiere);
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Matière créée avec succès !');
                fermerModal();
                afficherGestionMatieres();
            } else {
                alert('Erreur lors de la création: ' + result.error);
            }
        }

        // ============================================
        // GESTION DES NOTES
        // ============================================
        function afficherGestionNotes() {
            const notes = SCOLARIS_DATA.notes || [];
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Gestion des notes</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelleNote()">
                        <i class="fas fa-plus"></i> Nouvelle note
                    </button>
                </div>
                
                <div class="cards-container" style="margin-bottom: 30px;">
                    <div class="card">
                        <div class="card-title">Notes enregistrées</div>
                        <div class="card-value">${notes.length}</div>
                        <div class="card-subtitle">Total</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Moyenne générale</div>
                        <div class="card-value">${notes.length > 0 ? (notes.reduce((sum, n) => sum + n.valeur, 0) / notes.length).toFixed(2) : '0.00'}/20</div>
                        <div class="card-subtitle">Établissement</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Meilleure note</div>
                        <div class="card-value">${notes.length > 0 ? Math.max(...notes.map(n => n.valeur)).toFixed(2) : '0.00'}/20</div>
                        <div class="card-subtitle">Maximum</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Plus basse note</div>
                        <div class="card-value">${notes.length > 0 ? Math.min(...notes.map(n => n.valeur)).toFixed(2) : '0.00'}/20</div>
                        <div class="card-subtitle">Minimum</div>
                    </div>
                </div>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <select class="form-control" id="filtreNoteClasse" onchange="filtrerNotes()">
                            <option value="">Toutes les classes</option>
                            ${SCOLARIS_DATA.classes.map(classe => 
                                `<option value="${classe.id}">${classe.nom}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="filtreNoteMatiere" onchange="filtrerNotes()">
                            <option value="">Toutes les matières</option>
                            ${SCOLARIS_DATA.matieres.map(matiere => 
                                `<option value="${matiere.id}">${matiere.nom}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="filtreNotePeriode" onchange="filtrerNotes()">
                            <option value="">Toutes les périodes</option>
                            <option value="trimestre1">Trimestre 1</option>
                            <option value="trimestre2">Trimestre 2</option>
                            <option value="trimestre3">Trimestre 3</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Notes (${notes.length})</div>
                    </div>
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Élève</th>
                                    <th>Classe</th>
                                    <th>Matière</th>
                                    <th>Note</th>
                                    <th>Coefficient</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Commentaire</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${notes.map(note => {
                                    const eleve = SCOLARIS_DATA.eleves.find(e => e.id === note.eleve_id);
                                    const classe = eleve ? SCOLARIS_DATA.classes.find(c => c.id === eleve.classe_id) : null;
                                    const matiere = SCOLARIS_DATA.matieres.find(m => m.id === note.matiere_id);
                                    const noteClass = note.valeur < 10 ? 'badge-danger' : 
                                                     note.valeur < 12 ? 'badge-warning' : 
                                                     note.valeur < 14 ? 'badge-primary' : 'badge-success';
                                    
                                    return `
                                    <tr>
                                        <td>${eleve ? eleve.prenom + ' ' + eleve.nom : 'Inconnu'}</td>
                                        <td>${classe ? classe.nom : ''}</td>
                                        <td>${matiere ? matiere.nom : 'Inconnu'}</td>
                                        <td><span class="badge ${noteClass}">${note.valeur.toFixed(2)}/20</span></td>
                                        <td>${note.coefficient || 1}</td>
                                        <td>${formatDate(note.date)}</td>
                                        <td>${note.type || 'Contrôle'}</td>
                                        <td>${note.commentaire ? note.commentaire.substring(0, 30) + (note.commentaire.length > 30 ? '...' : '') : ''}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-secondary btn-small" onclick="modifierNote(${note.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-small" onclick="supprimerNote(${note.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                ${notes.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-graduation-cap" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucune note enregistrée</h3>
                    <p style="color: #888; margin-bottom: 25px;">Commencez par saisir des notes.</p>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelleNote()">
                        <i class="fas fa-plus"></i> Saisir la première note
                    </button>
                </div>` : ''}`;
            
            setActiveMenu('notes');
        }

        function ouvrirModalNouvelleNote() {
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">📝 Saisir une nouvelle note</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouvelleNote">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Élève *</label>
                                    <select class="form-control" id="noteEleve" required>
                                        <option value="">Sélectionner un élève</option>
                                        ${SCOLARIS_DATA.eleves.map(eleve => 
                                            `<option value="${eleve.id}">${eleve.prenom} ${eleve.nom} - ${eleve.classe || 'Non affecté'}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Matière *</label>
                                    <select class="form-control" id="noteMatiere" required>
                                        <option value="">Sélectionner une matière</option>
                                        ${SCOLARIS_DATA.matieres.map(matiere => 
                                            `<option value="${matiere.id}">${matiere.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Note *</label>
                                    <input type="number" class="form-control" id="noteValeur" min="0" max="20" step="0.25" required>
                                </div>
                                <div class="form-group">
                                    <label>Coefficient *</label>
                                    <input type="number" class="form-control" id="noteCoefficient" min="0.5" max="5" step="0.5" value="1" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type d'évaluation *</label>
                                    <select class="form-control" id="noteType" required>
                                        <option value="Contrôle">Contrôle</option>
                                        <option value="Devoir maison">Devoir maison</option>
                                        <option value="Interrogation">Interrogation</option>
                                        <option value="Oral">Oral</option>
                                        <option value="Projet">Projet</option>
                                        <option value="Participation">Participation</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-control" id="noteDate" 
                                           value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Période</label>
                                    <select class="form-control" id="notePeriode">
                                        <option value="trimestre1">Trimestre 1</option>
                                        <option value="trimestre2" selected>Trimestre 2</option>
                                        <option value="trimestre3">Trimestre 3</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Commentaire</label>
                                    <textarea class="form-control" id="noteCommentaire" rows="3" 
                                              placeholder="Remarques sur l'évaluation..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouvelleNote()">
                            <i class="fas fa-save"></i> Enregistrer la note
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        async function creerNouvelleNote() {
            const eleveId = parseInt(document.getElementById('noteEleve').value);
            const matiereId = parseInt(document.getElementById('noteMatiere').value);
            const valeur = parseFloat(document.getElementById('noteValeur').value);
            const coefficient = parseFloat(document.getElementById('noteCoefficient').value);
            const type = document.getElementById('noteType').value;
            const date = document.getElementById('noteDate').value;
            const periode = document.getElementById('notePeriode').value;
            const commentaire = document.getElementById('noteCommentaire').value;
            
            if (!eleveId || !matiereId || isNaN(valeur) || isNaN(coefficient) || !type || !date) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            if (valeur < 0 || valeur > 20) {
                alert('La note doit être comprise entre 0 et 20');
                return;
            }
            
            const nouvelId = Math.max(...SCOLARIS_DATA.notes.map(n => n.id), 0) + 1;
            const nouvelleNote = {
                id: nouvelId,
                eleve_id: eleveId,
                matiere_id: matiereId,
                valeur: valeur,
                coefficient: coefficient,
                type: type,
                date: date,
                periode: periode,
                commentaire: commentaire,
                saisie_par: utilisateurCourant.id,
                date_saisie: new Date().toISOString()
            };
            
            SCOLARIS_DATA.notes.push(nouvelleNote);
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Note enregistrée avec succès !');
                fermerModal();
                afficherGestionNotes();
            } else {
                alert('Erreur lors de l\'enregistrement: ' + result.error);
            }
        }

        // ============================================
        // GESTION DES ABSENCES
        // ============================================
        function afficherGestionAbsences() {
            const absences = SCOLARIS_DATA.absences || [];
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Gestion des absences</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelleAbsence()">
                        <i class="fas fa-plus"></i> Nouvelle absence
                    </button>
                </div>
                
                <div class="cards-container" style="margin-bottom: 30px;">
                    <div class="card">
                        <div class="card-title">Absences aujourd'hui</div>
                        <div class="card-value">${absences.filter(a => a.date === new Date().toISOString().split('T')[0]).length}</div>
                        <div class="card-subtitle">Élèves absents</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Absences ce mois</div>
                        <div class="card-value">${absences.filter(a => {
                            const dateAbs = new Date(a.date);
                            const now = new Date();
                            return dateAbs.getMonth() === now.getMonth() && dateAbs.getFullYear() === now.getFullYear();
                        }).length}</div>
                        <div class="card-subtitle">Cumul mensuel</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Retards aujourd'hui</div>
                        <div class="card-value">${SCOLARIS_DATA.retards.filter(r => r.date === new Date().toISOString().split('T')[0]).length}</div>
                        <div class="card-subtitle">Élèves en retard</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Justifiées</div>
                        <div class="card-value">${absences.filter(a => a.justifiee).length}</div>
                        <div class="card-subtitle">Absences justifiées</div>
                    </div>
                </div>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <input type="date" class="form-control" id="filtreAbsenceDate" 
                               value="${new Date().toISOString().split('T')[0]}" onchange="filtrerAbsences()">
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="filtreAbsenceClasse" onchange="filtrerAbsences()">
                            <option value="">Toutes les classes</option>
                            ${SCOLARIS_DATA.classes.map(classe => 
                                `<option value="${classe.id}">${classe.nom}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="filtreAbsenceJustifiee" onchange="filtrerAbsences()">
                            <option value="">Toutes</option>
                            <option value="oui">Justifiées</option>
                            <option value="non">Non justifiées</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Absences (${absences.length})</div>
                    </div>
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Élève</th>
                                    <th>Classe</th>
                                    <th>Date</th>
                                    <th>Heures</th>
                                    <th>Justifiée</th>
                                    <th>Motif</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${absences.map(absence => {
                                    const eleve = SCOLARIS_DATA.eleves.find(e => e.id === absence.eleve_id);
                                    const classe = eleve ? SCOLARIS_DATA.classes.find(c => c.id === eleve.classe_id) : null;
                                    const justifieeBadge = absence.justifiee ? 
                                        '<span class="badge badge-success">Oui</span>' : 
                                        '<span class="badge badge-danger">Non</span>';
                                    
                                    return `
                                    <tr>
                                        <td>${eleve ? eleve.prenom + ' ' + eleve.nom : 'Inconnu'}</td>
                                        <td>${classe ? classe.nom : ''}</td>
                                        <td>${formatDate(absence.date)}</td>
                                        <td>${absence.heures_absences || 'Toute la journée'}</td>
                                        <td>${justifieeBadge}</td>
                                        <td>${absence.motif ? absence.motif.substring(0, 30) + (absence.motif.length > 30 ? '...' : '') : ''}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-secondary btn-small" onclick="modifierAbsence(${absence.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-small" onclick="supprimerAbsence(${absence.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                ${absences.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-user-clock" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucune absence enregistrée</h3>
                    <p style="color: #888; margin-bottom: 25px;">Les absences apparaîtront ici.</p>
                </div>` : ''}`;
            
            setActiveMenu('absences');
        }

        function ouvrirModalNouvelleAbsence() {
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">⏰ Saisir une absence</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouvelleAbsence">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Élève *</label>
                                    <select class="form-control" id="absenceEleve" required>
                                        <option value="">Sélectionner un élève</option>
                                        ${SCOLARIS_DATA.eleves.map(eleve => 
                                            `<option value="${eleve.id}">${eleve.prenom} ${eleve.nom} - ${eleve.classe || 'Non affecté'}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-control" id="absenceDate" 
                                           value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type *</label>
                                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                                        <label>
                                            <input type="radio" name="typeAbsence" value="complet" checked>
                                            <span>Absence complète</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="typeAbsence" value="partiel">
                                            <span>Absence partielle</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="typeAbsence" value="retard">
                                            <span>Retard</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row" id="champsHeuresAbsence" style="display: none;">
                                <div class="form-group">
                                    <label>Heures d'absence</label>
                                    <input type="text" class="form-control" id="absenceHeures" 
                                           placeholder="Ex: 8h30-10h30, 14h-15h">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Motif *</label>
                                    <textarea class="form-control" id="absenceMotif" rows="3" required 
                                              placeholder="Raison de l'absence..."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label><input type="checkbox" id="absenceJustifiee"> Absence justifiée</label>
                                </div>
                                <div class="form-group">
                                    <label>Pièce justificative</label>
                                    <input type="text" class="form-control" id="absencePiece" 
                                           placeholder="Ex: Certificat médical n°...">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouvelleAbsence()">
                            <i class="fas fa-save"></i> Enregistrer l'absence
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
            
            document.querySelectorAll('input[name="typeAbsence"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const champsHeures = document.getElementById('champsHeuresAbsence');
                    champsHeures.style.display = this.value === 'partiel' ? 'block' : 'none';
                });
            });
        }

        async function creerNouvelleAbsence() {
            const eleveId = parseInt(document.getElementById('absenceEleve').value);
            const date = document.getElementById('absenceDate').value;
            const type = document.querySelector('input[name="typeAbsence"]:checked').value;
            const motif = document.getElementById('absenceMotif').value;
            const justifiee = document.getElementById('absenceJustifiee').checked;
            const piece = document.getElementById('absencePiece').value;
            
            if (!eleveId || !date || !motif) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            if (type === 'retard') {
                // Créer un retard plutôt qu'une absence
                const nouvelId = Math.max(...SCOLARIS_DATA.retards.map(r => r.id), 0) + 1;
                const nouveauRetard = {
                    id: nouvelId,
                    eleve_id: eleveId,
                    date: date,
                    duree: document.getElementById('absenceHeures').value || 'Non précisée',
                    motif: motif,
                    justifie: justifiee,
                    piece_justificative: piece,
                    enregistre_par: utilisateurCourant.id,
                    date_enregistrement: new Date().toISOString()
                };
                
                SCOLARIS_DATA.retards.push(nouveauRetard);
            } else {
                const nouvelId = Math.max(...SCOLARIS_DATA.absences.map(a => a.id), 0) + 1;
                const nouvelleAbsence = {
                    id: nouvelId,
                    eleve_id: eleveId,
                    date: date,
                    type: type,
                    heures_absences: type === 'partiel' ? document.getElementById('absenceHeures').value : null,
                    motif: motif,
                    justifiee: justifiee,
                    piece_justificative: piece,
                    enregistre_par: utilisateurCourant.id,
                    date_enregistrement: new Date().toISOString()
                };
                
                SCOLARIS_DATA.absences.push(nouvelleAbsence);
            }
            
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert(type === 'retard' ? 'Retard enregistré avec succès !' : 'Absence enregistrée avec succès !');
                fermerModal();
                afficherGestionAbsences();
            } else {
                alert('Erreur lors de l\'enregistrement: ' + result.error);
            }
        }

        // ============================================
        // GESTION DES SANCTIONS
        // ============================================
        function afficherGestionSanctions() {
            const sanctions = SCOLARIS_DATA.sanctions || [];
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Gestion des sanctions</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelleSanction()">
                        <i class="fas fa-gavel"></i> Nouvelle sanction
                    </button>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="changerOngletSanctions('toutes')">Toutes</div>
                    <div class="tab" onclick="changerOngletSanctions('retenues')">Retenues</div>
                    <div class="tab" onclick="changerOngletSanctions('avertissements')">Avertissements</div>
                    <div class="tab" onclick="changerOngletSanctions('exclusions')">Exclusions</div>
                    <div class="tab" onclick="changerOngletSanctions('blames')">Blâmes</div>
                </div>
                
                <div id="contenuSanctions">
                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">Sanctions (${sanctions.length})</div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Élève</th>
                                        <th>Classe</th>
                                        <th>Date</th>
                                        <th>Motif</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sanctions.map(sanction => {
                                        const eleve = SCOLARIS_DATA.eleves.find(e => e.id === sanction.eleve_id);
                                        const classe = eleve ? SCOLARIS_DATA.classes.find(c => c.id === eleve.classe_id) : null;
                                        const typeBadge = getSanctionBadge(sanction.type);
                                        
                                        return `
                                        <tr>
                                            <td>${typeBadge}</td>
                                            <td>${eleve ? eleve.prenom + ' ' + eleve.nom : 'Inconnu'}</td>
                                            <td>${classe ? classe.nom : ''}</td>
                                            <td>${formatDate(sanction.date)}</td>
                                            <td>${sanction.motif.substring(0, 50)}${sanction.motif.length > 50 ? '...' : ''}</td>
                                            <td>${sanction.statut === 'active' ? 
                                                '<span class="badge badge-warning">Active</span>' : 
                                                '<span class="badge badge-success">Terminée</span>'}</td>
                                            <td>
                                                <div style="display: flex; gap: 5px;">
                                                    <button class="btn btn-secondary btn-small" onclick="voirDetailsSanction(${sanction.id})">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-small" onclick="supprimerSanction(${sanction.id})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                ${sanctions.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-gavel" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucune sanction enregistrée</h3>
                    <p style="color: #888; margin-bottom: 25px;">Les sanctions apparaîtront ici.</p>
                </div>` : ''}`;
            
            setActiveMenu('sanctions');
        }

        function ouvrirModalNouvelleSanction() {
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">⚖️ Nouvelle sanction</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouvelleSanction">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type de sanction *</label>
                                    <select class="form-control" id="sanctionType" required>
                                        <option value="">Sélectionner</option>
                                        <option value="retenue">Retenue</option>
                                        <option value="avertissement">Avertissement</option>
                                        <option value="exclusion">Exclusion temporaire</option>
                                        <option value="blame">Blâme</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Élève concerné *</label>
                                    <select class="form-control" id="sanctionEleve" required>
                                        <option value="">Sélectionner un élève</option>
                                        ${SCOLARIS_DATA.eleves.map(eleve => 
                                            `<option value="${eleve.id}">${eleve.prenom} ${eleve.nom} - ${eleve.classe || 'Non affecté'}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date de la sanction *</label>
                                    <input type="date" class="form-control" id="sanctionDate" 
                                           value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                                <div class="form-group">
                                    <label>Heure</label>
                                    <input type="time" class="form-control" id="sanctionHeure" value="14:00">
                                </div>
                            </div>
                            
                            <div class="form-row" id="champsRetenue" style="display: none;">
                                <div class="form-group">
                                    <label>Date de la retenue</label>
                                    <input type="date" class="form-control" id="retenueDate">
                                </div>
                                <div class="form-group">
                                    <label>Durée (heures)</label>
                                    <input type="number" class="form-control" id="retenueDuree" min="1" max="4" value="2">
                                </div>
                            </div>
                            
                            <div class="form-row" id="champsExclusion" style="display: none;">
                                <div class="form-group">
                                    <label>Durée de l'exclusion (jours)</label>
                                    <input type="number" class="form-control" id="exclusionDuree" min="1" max="8" value="1">
                                </div>
                                <div class="form-group">
                                    <label>Date de retour</label>
                                    <input type="date" class="form-control" id="exclusionRetour">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Motif *</label>
                                    <textarea class="form-control" id="sanctionMotif" rows="3" required 
                                              placeholder="Décrire le comportement sanctionné..."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Sanctionné par *</label>
                                    <select class="form-control" id="sanctionPar" required>
                                        <option value="">Sélectionner</option>
                                        ${SCOLARIS_DATA.utilisateurs
                                            .filter(u => ['proviseur', 'proviseur_adjoint', 'cpe', 'enseignant'].includes(u.role))
                                            .map(u => `<option value="${u.id}">${u.prenom} ${u.nom}</option>`)
                                            .join('')}
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouvelleSanction()">
                            <i class="fas fa-save"></i> Enregistrer la sanction
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
            
            document.getElementById('sanctionType').addEventListener('change', function() {
                const type = this.value;
                document.getElementById('champsRetenue').style.display = type === 'retenue' ? 'block' : 'none';
                document.getElementById('champsExclusion').style.display = type === 'exclusion' ? 'block' : 'none';
            });
        }

        async function creerNouvelleSanction() {
            const type = document.getElementById('sanctionType').value;
            const eleveId = parseInt(document.getElementById('sanctionEleve').value);
            const date = document.getElementById('sanctionDate').value;
            const heure = document.getElementById('sanctionHeure').value;
            const motif = document.getElementById('sanctionMotif').value;
            const sanctionPar = parseInt(document.getElementById('sanctionPar').value);
            
            if (!type || !eleveId || !date || !motif || !sanctionPar) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (!SCOLARIS_DATA.sanctions) SCOLARIS_DATA.sanctions = [];
            
            const nouvelId = Math.max(...SCOLARIS_DATA.sanctions.map(s => s.id), 0) + 1;
            const nouvelleSanction = {
                id: nouvelId,
                type: type,
                eleve_id: eleveId,
                date: date,
                heure: heure,
                motif: motif,
                sanctionne_par: sanctionPar,
                statut: 'active',
                date_creation: new Date().toISOString().split('T')[0],
                created_by: utilisateurCourant.id
            };
            
            if (type === 'retenue') {
                nouvelleSanction.date_retenue = document.getElementById('retenueDate').value;
                nouvelleSanction.duree_heures = parseInt(document.getElementById('retenueDuree').value);
            }
            
            if (type === 'exclusion') {
                nouvelleSanction.duree_jours = parseInt(document.getElementById('exclusionDuree').value);
                nouvelleSanction.date_retour = document.getElementById('exclusionRetour').value;
            }
            
            SCOLARIS_DATA.sanctions.push(nouvelleSanction);
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Sanction enregistrée avec succès !');
                fermerModal();
                afficherGestionSanctions();
            } else {
                alert('Erreur lors de l\'enregistrement: ' + result.error);
            }
        }

        function getSanctionBadge(type) {
            switch(type) {
                case 'retenue': return '<span class="sanction-type sanction-retenue">Retenue</span>';
                case 'avertissement': return '<span class="sanction-type sanction-avertissement">Avertissement</span>';
                case 'exclusion': return '<span class="sanction-type sanction-exclusion">Exclusion</span>';
                case 'blame': return '<span class="sanction-type sanction-blame">Blâme</span>';
                default: return '<span class="badge badge-secondary">' + type + '</span>';
            }
        }

        // ============================================
        // GESTION DES OBSERVATIONS
        // ============================================
        function afficherGestionObservations() {
            const observations = SCOLARIS_DATA.observations || [];
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Carnet d'observations</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelleObservation()">
                        <i class="fas fa-sticky-note"></i> Nouvelle observation
                    </button>
                </div>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <select class="form-control" id="filtreObservationEleve" onchange="filtrerObservations()">
                            <option value="">Tous les élèves</option>
                            ${SCOLARIS_DATA.eleves.map(eleve => 
                                `<option value="${eleve.id}">${eleve.prenom} ${eleve.nom}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="filtreObservationType" onchange="filtrerObservations()">
                            <option value="">Tous les types</option>
                            <option value="positive">Positive</option>
                            <option value="negative">Négative</option>
                            <option value="neutre">Neutre</option>
                        </select>
                    </div>
                </div>
                
                <div id="listeObservations">
                    ${observations.map(observation => {
                        const eleve = SCOLARIS_DATA.eleves.find(e => e.id === observation.eleve_id);
                        const matiere = observation.matiere_id ? 
                            SCOLARIS_DATA.matieres.find(m => m.id === observation.matiere_id) : null;
                        const typeClass = observation.type === 'positive' ? 'observation-positive' : 
                                         observation.type === 'negative' ? 'observation-negative' : 'observation-neutre';
                        
                        return `
                        <div class="observation-card ${typeClass}">
                            <div class="cours-header">
                                <div>
                                    <strong>${eleve ? eleve.prenom + ' ' + eleve.nom : 'Inconnu'}</strong>
                                    ${matiere ? ' - ' + matiere.nom : ''}
                                </div>
                                <div class="cours-horaire">${formatDate(observation.date)}</div>
                            </div>
                            <h4 style="margin: 10px 0 5px 0;">${observation.titre}</h4>
                            <p style="color: #666;">${observation.description}</p>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #888;">
                                Par ${observation.auteur_nom || 'Inconnu'}
                                <button class="btn btn-danger btn-small" style="float: right;" onclick="supprimerObservation(${observation.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
                
                ${observations.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-sticky-note" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucune observation</h3>
                    <p style="color: #888; margin-bottom: 25px;">Les observations apparaîtront ici.</p>
                </div>` : ''}`;
            
            setActiveMenu('observations');
        }

        function ouvrirModalNouvelleObservation() {
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">📝 Nouvelle observation</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouvelleObservation">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type d'observation *</label>
                                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                                        <label>
                                            <input type="radio" name="typeObservation" value="positive" checked>
                                            <span style="color: #27AE60;"><i class="fas fa-thumbs-up"></i> Positive</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="typeObservation" value="negative">
                                            <span style="color: #E74C3C;"><i class="fas fa-thumbs-down"></i> Négative</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="typeObservation" value="neutre">
                                            <span style="color: #95A5A6;"><i class="fas fa-minus"></i> Neutre</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Élève(s) concerné(s) *</label>
                                    <select class="form-control" id="observationEleves" multiple style="height: 150px;">
                                        ${SCOLARIS_DATA.eleves.map(eleve => 
                                            `<option value="${eleve.id}">${eleve.prenom} ${eleve.nom} - ${eleve.classe || 'Non affecté'}</option>`
                                        ).join('')}
                                    </select>
                                    <small class="text-muted">Maintenez Ctrl pour sélectionner plusieurs élèves</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Matière</label>
                                    <select class="form-control" id="observationMatiere">
                                        <option value="">Général</option>
                                        ${SCOLARIS_DATA.matieres.map(matiere => 
                                            `<option value="${matiere.id}">${matiere.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-control" id="observationDate" 
                                           value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Titre *</label>
                                    <input type="text" class="form-control" id="observationTitre" 
                                           placeholder="Ex: Participation active en cours" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Description détaillée *</label>
                                    <textarea class="form-control" id="observationDescription" rows="5" required
                                              placeholder="Décrire l'observation en détail..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouvelleObservation()">
                            <i class="fas fa-save"></i> Enregistrer l'observation
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        async function creerNouvelleObservation() {
            const type = document.querySelector('input[name="typeObservation"]:checked').value;
            const elevesSelect = document.getElementById('observationEleves');
            const matiereId = document.getElementById('observationMatiere').value;
            const date = document.getElementById('observationDate').value;
            const titre = document.getElementById('observationTitre').value;
            const description = document.getElementById('observationDescription').value;
            
            if (!elevesSelect.selectedOptions.length || !titre || !description) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            const elevesIds = Array.from(elevesSelect.selectedOptions).map(opt => parseInt(opt.value));
            const matiere = matiereId ? SCOLARIS_DATA.matieres.find(m => m.id === parseInt(matiereId)) : null;
            
            if (!SCOLARIS_DATA.observations) SCOLARIS_DATA.observations = [];
            
            elevesIds.forEach(eleveId => {
                const nouvelId = Math.max(...SCOLARIS_DATA.observations.map(o => o.id), 0) + 1;
                const nouvelleObservation = {
                    id: nouvelId,
                    type: type,
                    eleve_id: eleveId,
                    matiere_id: matiereId ? parseInt(matiereId) : null,
                    matiere_nom: matiere ? matiere.nom : null,
                    date: date,
                    titre: titre,
                    description: description,
                    auteur_id: utilisateurCourant.id,
                    auteur_nom: `${utilisateurCourant.prenom} ${utilisateurCourant.nom}`,
                    date_creation: new Date().toISOString()
                };
                
                SCOLARIS_DATA.observations.push(nouvelleObservation);
            });
            
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Observation(s) enregistrée(s) avec succès !');
                fermerModal();
                afficherGestionObservations();
            } else {
                alert('Erreur lors de l\'enregistrement: ' + result.error);
            }
        }

        // ============================================
        // CAHIER DE TEXTES EN TEMPS RÉEL
        // ============================================
        function afficherCahierTextes() {
            const cahierTextes = SCOLARIS_DATA.cahier_textes || [];
            const aujourdhui = new Date().toISOString().split('T')[0];
            const coursAujourdhui = cahierTextes.filter(c => c.date === aujourdhui);
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Cahier de textes</h1>
                    <div>
                        <button class="btn btn-primary" onclick="ouvrirModalNouveauCours()">
                            <i class="fas fa-plus"></i> Ajouter un cours
                        </button>
                    </div>
                </div>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-control" id="filtreCahierDate" 
                               value="${aujourdhui}" onchange="filtrerCahierTextes()">
                    </div>
                    <div class="form-group">
                        <label>Classe</label>
                        <select class="form-control" id="filtreCahierClasse" onchange="filtrerCahierTextes()">
                            <option value="">Toutes les classes</option>
                            ${SCOLARIS_DATA.classes.map(classe => 
                                `<option value="${classe.id}">${classe.nom}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                <h3 style="color: var(--couleur-principale); margin-bottom: 20px;">
                    Cours du ${formatDate(aujourdhui)} (${coursAujourdhui.length})
                </h3>
                
                <div id="listeCahierTextes">
                    ${coursAujourdhui.length > 0 ? coursAujourdhui.map(cours => {
                        const classe = SCOLARIS_DATA.classes.find(c => c.id === cours.classe_id);
                        const matiere = SCOLARIS_DATA.matieres.find(m => m.id === cours.matiere_id);
                        const professeur = SCOLARIS_DATA.utilisateurs.find(u => u.id === cours.professeur_id);
                        
                        return `
                        <div class="cours-session" onclick="voirDetailsCours(${cours.id})">
                            <div class="cours-header">
                                <div class="cours-matiere">
                                    <i class="fas fa-book" style="color: ${matiere ? matiere.couleur : '#3498DB'}; margin-right: 8px;"></i>
                                    ${matiere ? matiere.nom : 'Matière inconnue'} - ${classe ? classe.nom : 'Classe inconnue'}
                                </div>
                                <div class="cours-horaire">
                                    ${cours.heure_debut} - ${cours.heure_fin}
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Objectif :</strong> ${cours.objectif || 'Non spécifié'}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <small><i class="fas fa-chalkboard-teacher"></i> ${professeur ? professeur.prenom + ' ' + professeur.nom : 'Professeur inconnu'}</small>
                                    <small style="margin-left: 15px;"><i class="fas fa-door-closed"></i> ${cours.salle || 'Salle non spécifiée'}</small>
                                </div>
                                <div>
                                    ${cours.devoirs ? `<span class="badge badge-primary"><i class="fas fa-tasks"></i> Devoir</span>` : ''}
                                    ${cours.documents ? `<span class="badge badge-info" style="margin-left: 5px;"><i class="fas fa-paperclip"></i> Document</span>` : ''}
                                </div>
                            </div>
                        </div>`;
                    }).join('') : `
                    <div class="form-container" style="text-align: center; padding: 40px;">
                        <i class="fas fa-calendar-alt" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #666; margin-bottom: 15px;">Aucun cours aujourd'hui</h3>
                        <p style="color: #888; margin-bottom: 25px;">Ajoutez des cours pour les voir apparaître ici.</p>
                        <button class="btn btn-primary" onclick="ouvrirModalNouveauCours()">
                            <i class="fas fa-plus"></i> Ajouter un cours
                        </button>
                    </div>`}
                </div>`;
            
            setActiveMenu('cahier_textes');
        }

        function ouvrirModalNouveauCours() {
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">📚 Ajouter un cours au cahier de textes</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouveauCours">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-control" id="coursDate" 
                                           value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                                <div class="form-group">
                                    <label>Classe *</label>
                                    <select class="form-control" id="coursClasse" required>
                                        <option value="">Sélectionner une classe</option>
                                        ${SCOLARIS_DATA.classes.map(classe => 
                                            `<option value="${classe.id}">${classe.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Matière *</label>
                                    <select class="form-control" id="coursMatiere" required>
                                        <option value="">Sélectionner une matière</option>
                                        ${SCOLARIS_DATA.matieres.map(matiere => 
                                            `<option value="${matiere.id}">${matiere.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Professeur *</label>
                                    <select class="form-control" id="coursProfesseur" required>
                                        <option value="">Sélectionner un professeur</option>
                                        ${SCOLARIS_DATA.utilisateurs
                                            .filter(u => u.role === 'enseignant' && u.actif)
                                            .map(prof => `<option value="${prof.id}">${prof.prenom} ${prof.nom}</option>`)
                                            .join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Heure de début *</label>
                                    <input type="time" class="form-control" id="coursHeureDebut" value="08:30" required>
                                </div>
                                <div class="form-group">
                                    <label>Heure de fin *</label>
                                    <input type="time" class="form-control" id="coursHeureFin" value="09:30" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Salle</label>
                                    <input type="text" class="form-control" id="coursSalle" placeholder="Ex: Salle 201">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Objectif du cours *</label>
                                    <input type="text" class="form-control" id="coursObjectif" 
                                           placeholder="Ex: Introduction aux équations du second degré" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Contenu détaillé *</label>
                                    <textarea class="form-control" id="coursContenu" rows="4" required
                                              placeholder="Décrire le déroulement du cours..."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Travail à faire (devoirs)</label>
                                    <textarea class="form-control" id="coursDevoirs" rows="3"
                                              placeholder="Exercices, recherches, préparation..."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Documents joints</label>
                                    <input type="file" class="form-control" id="coursDocuments" multiple>
                                    <small class="text-muted">PDF, images, fichiers texte...</small>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouveauCours()">
                            <i class="fas fa-save"></i> Enregistrer le cours
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        async function creerNouveauCours() {
            const date = document.getElementById('coursDate').value;
            const classeId = parseInt(document.getElementById('coursClasse').value);
            const matiereId = parseInt(document.getElementById('coursMatiere').value);
            const professeurId = parseInt(document.getElementById('coursProfesseur').value);
            const heureDebut = document.getElementById('coursHeureDebut').value;
            const heureFin = document.getElementById('coursHeureFin').value;
            const salle = document.getElementById('coursSalle').value;
            const objectif = document.getElementById('coursObjectif').value;
            const contenu = document.getElementById('coursContenu').value;
            
            if (!date || !classeId || !matiereId || !professeurId || !heureDebut || !heureFin || !objectif || !contenu) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            if (!SCOLARIS_DATA.cahier_textes) SCOLARIS_DATA.cahier_textes = [];
            
            const nouvelId = Math.max(...SCOLARIS_DATA.cahier_textes.map(c => c.id), 0) + 1;
            const nouveauCours = {
                id: nouvelId,
                date: date,
                classe_id: classeId,
                matiere_id: matiereId,
                professeur_id: professeurId,
                heure_debut: heureDebut,
                heure_fin: heureFin,
                salle: salle,
                objectif: objectif,
                contenu: contenu,
                devoirs: document.getElementById('coursDevoirs').value,
                created_by: utilisateurCourant.id,
                created_at: new Date().toISOString()
            };
            
            SCOLARIS_DATA.cahier_textes.push(nouveauCours);
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Cours ajouté au cahier de textes avec succès !');
                fermerModal();
                afficherCahierTextes();
            } else {
                alert('Erreur lors de l\'ajout: ' + result.error);
            }
        }

        function voirDetailsCours(coursId) {
            const cours = SCOLARIS_DATA.cahier_textes.find(c => c.id === coursId);
            if (!cours) return;
            
            const classe = SCOLARIS_DATA.classes.find(c => c.id === cours.classe_id);
            const matiere = SCOLARIS_DATA.matieres.find(m => m.id === cours.matiere_id);
            const professeur = SCOLARIS_DATA.utilisateurs.find(u => u.id === cours.professeur_id);
            
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">📖 Détails du cours</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>
                                <h3 style="color: var(--couleur-principale); margin-bottom: 5px;">
                                    ${matiere ? matiere.nom : 'Matière inconnue'}
                                </h3>
                                <p><i class="fas fa-users"></i> ${classe ? classe.nom : 'Classe inconnue'}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>${formatDate(cours.date)}</strong></p>
                                <p>${cours.heure_debut} - ${cours.heure_fin}</p>
                                <p><i class="fas fa-door-closed"></i> ${cours.salle || 'Salle non spécifiée'}</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--couleur-principale); margin-bottom: 10px;">
                                <i class="fas fa-bullseye"></i> Objectif
                            </h4>
                            <p>${cours.objectif}</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--couleur-principale); margin-bottom: 10px;">
                                <i class="fas fa-book-open"></i> Contenu du cours
                            </h4>
                            <p>${cours.contenu.replace(/\n/g, '<br>')}</p>
                        </div>
                        
                        ${cours.devoirs ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--couleur-principale); margin-bottom: 10px;">
                                <i class="fas fa-tasks"></i> Travail à faire
                            </h4>
                            <p>${cours.devoirs.replace(/\n/g, '<br>')}</p>
                        </div>` : ''}
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                            <p><strong>Professeur :</strong> ${professeur ? professeur.prenom + ' ' + professeur.nom : 'Inconnu'}</p>
                            <p><strong>Ajouté le :</strong> ${formatDateTime(cours.created_at)}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Fermer</button>
                        ${utilisateurCourant.id === cours.created_by || utilisateurCourant.role === 'admin_systeme' || utilisateurCourant.role === 'proviseur' ? `
                        <button class="btn btn-primary" onclick="modifierCours(${cours.id})">
                            <i class="fas fa-edit"></i> Modifier
                        </button>` : ''}
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        // ============================================
        // EMPLOI DU TEMPS
        // ============================================
        function afficherEmploiDuTemps() {
            const emploi = SCOLARIS_DATA.emploi_du_temps || [];
            const jours = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
            const creneaux = ['8:30-9:30', '9:30-10:30', '10:45-11:45', '13:30-14:30', '14:30-15:30', '15:45-16:45'];
            
            let emploiHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Emploi du temps</h1>
                    <div>
                        <button class="btn btn-primary" onclick="ouvrirModalNouveauCreneau()">
                            <i class="fas fa-plus"></i> Ajouter un créneau
                        </button>
                        <button class="btn btn-secondary" onclick="genererEmploiDuTemps()" style="margin-left: 10px;">
                            <i class="fas fa-magic"></i> Générer automatiquement
                        </button>
                    </div>
                </div>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Classe</label>
                        <select class="form-control" id="filtreEmploiClasse" onchange="filtrerEmploiDuTemps()">
                            <option value="">Toutes les classes</option>
                            ${SCOLARIS_DATA.classes.map(classe => 
                                `<option value="${classe.id}">${classe.nom}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Professeur</label>
                        <select class="form-control" id="filtreEmploiProfesseur" onchange="filtrerEmploiDuTemps()">
                            <option value="">Tous les professeurs</option>
                            ${SCOLARIS_DATA.utilisateurs
                                .filter(u => u.role === 'enseignant' && u.actif)
                                .map(prof => `<option value="${prof.id}">${prof.prenom} ${prof.nom}</option>`)
                                .join('')}
                        </select>
                    </div>
                </div>`;
            
            // Si l'utilisateur est un enseignant, afficher son emploi du temps
            if (utilisateurCourant.role === 'enseignant') {
                const mesCours = emploi.filter(e => e.professeur_id === utilisateurCourant.id);
                emploiHtml += `
                    <h3 style="color: var(--couleur-principale); margin-bottom: 20px;">
                        <i class="fas fa-chalkboard-teacher"></i> Mon emploi du temps
                    </h3>
                    
                    <div class="emploi-container">
                        <div class="emploi-cell emploi-header">Heure</div>
                        ${jours.map(jour => `<div class="emploi-cell emploi-header">${jour}</div>`).join('')}
                        
                        ${creneaux.map((creneau, index) => {
                            return `
                            <div class="emploi-cell emploi-header">${creneau}</div>
                            ${jours.map(jour => {
                                const cours = mesCours.find(c => 
                                    c.jour === jour.toLowerCase() && c.creneau === index
                                );
                                
                                if (cours) {
                                    const matiere = SCOLARIS_DATA.matieres.find(m => m.id === cours.matiere_id);
                                    const classe = SCOLARIS_DATA.classes.find(c => c.id === cours.classe_id);
                                    return `
                                    <div class="emploi-cell">
                                        <div class="emploi-creneau" onclick="voirDetailsCoursEDT(${cours.id})" 
                                             style="border-left-color: ${matiere ? matiere.couleur : '#3498DB'}">
                                            <strong>${matiere ? matiere.nom.substring(0, 15) : 'Cours'}</strong><br>
                                            <small>${classe ? classe.nom : ''}</small><br>
                                            <small>${cours.salle || ''}</small>
                                        </div>
                                    </div>`;
                                } else {
                                    return `<div class="emploi-cell"></div>`;
                                }
                            }).join('')}`;
                        }).join('')}
                    </div>`;
            } else {
                // Affichage pour admin/proviseur
                emploiHtml += `
                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">Tous les créneaux (${emploi.length})</div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Jour</th>
                                        <th>Créneau</th>
                                        <th>Classe</th>
                                        <th>Matière</th>
                                        <th>Professeur</th>
                                        <th>Salle</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${emploi.map(cours => {
                                        const classe = SCOLARIS_DATA.classes.find(c => c.id === cours.classe_id);
                                        const matiere = SCOLARIS_DATA.matieres.find(m => m.id === cours.matiere_id);
                                        const professeur = SCOLARIS_DATA.utilisateurs.find(u => u.id === cours.professeur_id);
                                        
                                        return `
                                        <tr>
                                            <td>${cours.jour.charAt(0).toUpperCase() + cours.jour.slice(1)}</td>
                                            <td>${creneaux[cours.creneau] || 'Inconnu'}</td>
                                            <td>${classe ? classe.nom : 'Inconnu'}</td>
                                            <td>${matiere ? matiere.nom : 'Inconnu'}</td>
                                            <td>${professeur ? professeur.prenom + ' ' + professeur.nom : 'Inconnu'}</td>
                                            <td>${cours.salle || ''}</td>
                                            <td>
                                                <div style="display: flex; gap: 5px;">
                                                    <button class="btn btn-secondary btn-small" onclick="modifierCreneauEDT(${cours.id})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-small" onclick="supprimerCreneauEDT(${cours.id})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }
            
            document.getElementById('contenuPrincipal').innerHTML = emploiHtml;
            setActiveMenu('emploi_temps');
        }

        function ouvrirModalNouveauCreneau() {
            const modalHtml = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">⏰ Ajouter un créneau à l'emploi du temps</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouveauCreneau">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Jour *</label>
                                    <select class="form-control" id="creneauJour" required>
                                        <option value="">Sélectionner</option>
                                        <option value="lundi">Lundi</option>
                                        <option value="mardi">Mardi</option>
                                        <option value="mercredi">Mercredi</option>
                                        <option value="jeudi">Jeudi</option>
                                        <option value="vendredi">Vendredi</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Créneau *</label>
                                    <select class="form-control" id="creneauHoraire" required>
                                        <option value="">Sélectionner</option>
                                        <option value="0">8:30 - 9:30</option>
                                        <option value="1">9:30 - 10:30</option>
                                        <option value="2">10:45 - 11:45</option>
                                        <option value="3">13:30 - 14:30</option>
                                        <option value="4">14:30 - 15:30</option>
                                        <option value="5">15:45 - 16:45</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Classe *</label>
                                    <select class="form-control" id="creneauClasse" required>
                                        <option value="">Sélectionner une classe</option>
                                        ${SCOLARIS_DATA.classes.map(classe => 
                                            `<option value="${classe.id}">${classe.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Matière *</label>
                                    <select class="form-control" id="creneauMatiere" required>
                                        <option value="">Sélectionner une matière</option>
                                        ${SCOLARIS_DATA.matieres.map(matiere => 
                                            `<option value="${matiere.id}">${matiere.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Professeur *</label>
                                    <select class="form-control" id="creneauProfesseur" required>
                                        <option value="">Sélectionner un professeur</option>
                                        ${SCOLARIS_DATA.utilisateurs
                                            .filter(u => u.role === 'enseignant' && u.actif)
                                            .map(prof => `<option value="${prof.id}">${prof.prenom} ${prof.nom}</option>`)
                                            .join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Salle</label>
                                    <input type="text" class="form-control" id="creneauSalle" placeholder="Ex: Salle 201">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouveauCreneau()">
                            <i class="fas fa-save"></i> Ajouter le créneau
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        async function creerNouveauCreneau() {
            const jour = document.getElementById('creneauJour').value;
            const creneau = parseInt(document.getElementById('creneauHoraire').value);
            const classeId = parseInt(document.getElementById('creneauClasse').value);
            const matiereId = parseInt(document.getElementById('creneauMatiere').value);
            const professeurId = parseInt(document.getElementById('creneauProfesseur').value);
            const salle = document.getElementById('creneauSalle').value;
            
            if (!jour || creneau === undefined || !classeId || !matiereId || !professeurId) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            // Vérifier si le créneau est déjà occupé pour cette classe
            const creneauExistant = (SCOLARIS_DATA.emploi_du_temps || []).find(e => 
                e.jour === jour && e.creneau === creneau && e.classe_id === classeId
            );
            
            if (creneauExistant) {
                alert('Ce créneau est déjà occupé pour cette classe !');
                return;
            }
            
            // Vérifier si le professeur a déjà un cours à ce créneau
            const professeurOccupe = (SCOLARIS_DATA.emploi_du_temps || []).find(e => 
                e.jour === jour && e.creneau === creneau && e.professeur_id === professeurId
            );
            
            if (professeurOccupe) {
                const classe = SCOLARIS_DATA.classes.find(c => c.id === professeurOccupe.classe_id);
                alert(`Le professeur a déjà un cours à ce créneau avec la classe ${classe ? classe.nom : 'inconnue'} !`);
                return;
            }
            
            if (!SCOLARIS_DATA.emploi_du_temps) SCOLARIS_DATA.emploi_du_temps = [];
            
            const nouvelId = Math.max(...SCOLARIS_DATA.emploi_du_temps.map(e => e.id), 0) + 1;
            const nouveauCreneau = {
                id: nouvelId,
                jour: jour,
                creneau: creneau,
                classe_id: classeId,
                matiere_id: matiereId,
                professeur_id: professeurId,
                salle: salle,
                created_by: utilisateurCourant.id,
                created_at: new Date().toISOString()
            };
            
            SCOLARIS_DATA.emploi_du_temps.push(nouveauCreneau);
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Créneau ajouté à l\'emploi du temps avec succès !');
                fermerModal();
                afficherEmploiDuTemps();
            } else {
                alert('Erreur lors de l\'ajout: ' + result.error);
            }
        }

        // ============================================
        // GESTION DES DEVOIRS
        // ============================================
        function afficherGestionDevoirs() {
            const devoirs = SCOLARIS_DATA.devoirs || [];
            const mesDevoirs = devoirs.filter(d => 
                utilisateurCourant.role === 'enseignant' ? 
                d.professeur_id === utilisateurCourant.id :
                true
            );
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Gestion des devoirs</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouveauDevoir()">
                        <i class="fas fa-plus"></i> Nouveau devoir
                    </button>
                </div>
                
                <div class="cards-container" style="margin-bottom: 30px;">
                    <div class="card">
                        <div class="card-title">Devoirs en cours</div>
                        <div class="card-value">${mesDevoirs.filter(d => d.statut === 'à_rendre').length}</div>
                        <div class="card-subtitle">À rendre</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Devoirs rendus</div>
                        <div class="card-value">${mesDevoirs.filter(d => d.statut === 'rendu').length}</div>
                        <div class="card-subtitle">En attente de correction</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Devoirs corrigés</div>
                        <div class="card-value">${mesDevoirs.filter(d => d.statut === 'corrigé').length}</div>
                        <div class="card-subtitle">Terminés</div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="changerOngletDevoirs('à_rendre')">À rendre</div>
                    <div class="tab" onclick="changerOngletDevoirs('rendu')">Rendus</div>
                    <div class="tab" onclick="changerOngletDevoirs('corrigé')">Corrigés</div>
                    <div class="tab" onclick="changerOngletDevoirs('en_retard')">En retard</div>
                </div>
                
                <div id="contenuDevoirs">
                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">Devoirs (${mesDevoirs.length})</div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Matière</th>
                                        <th>Classe</th>
                                        <th>Titre</th>
                                        <th>Date de rendu</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${mesDevoirs.map(devoir => {
                                        const matiere = SCOLARIS_DATA.matieres.find(m => m.id === devoir.matiere_id);
                                        const classe = SCOLARIS_DATA.classes.find(c => c.id === devoir.classe_id);
                                        const statutBadge = getStatutDevoirBadge(devoir.statut);
                                        
                                        return `
                                        <tr>
                                            <td>${matiere ? matiere.nom : 'Inconnu'}</td>
                                            <td>${classe ? classe.nom : 'Inconnu'}</td>
                                            <td>${devoir.titre}</td>
                                            <td>${formatDate(devoir.date_rendu)}</td>
                                            <td>${statutBadge}</td>
                                            <td>
                                                <div style="display: flex; gap: 5px;">
                                                    <button class="btn btn-secondary btn-small" onclick="voirDetailsDevoir(${devoir.id})">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    ${utilisateurCourant.role === 'enseignant' && devoir.professeur_id === utilisateurCourant.id ? `
                                                    <button class="btn btn-primary btn-small" onclick="corrigerDevoir(${devoir.id})">
                                                        <i class="fas fa-check"></i>
                                                    </button>` : ''}
                                                </div>
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                ${mesDevoirs.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-tasks" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucun devoir</h3>
                    <p style="color: #888; margin-bottom: 25px;">Les devoirs apparaîtront ici.</p>
                </div>` : ''}`;
            
            setActiveMenu('devoirs');
        }

        function ouvrirModalNouveauDevoir() {
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">📝 Nouveau devoir</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="formNouveauDevoir">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Titre *</label>
                                    <input type="text" class="form-control" id="devoirTitre" required 
                                           placeholder="Ex: Exercices sur les équations">
                                </div>
                                <div class="form-group">
                                    <label>Matière *</label>
                                    <select class="form-control" id="devoirMatiere" required>
                                        <option value="">Sélectionner une matière</option>
                                        ${SCOLARIS_DATA.matieres.map(matiere => 
                                            `<option value="${matiere.id}">${matiere.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Classe *</label>
                                    <select class="form-control" id="devoirClasse" required>
                                        <option value="">Sélectionner une classe</option>
                                        ${SCOLARIS_DATA.classes.map(classe => 
                                            `<option value="${classe.id}">${classe.nom}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date de rendu *</label>
                                    <input type="date" class="form-control" id="devoirDateRendu" required
                                           value="${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Description détaillée *</label>
                                    <textarea class="form-control" id="devoirDescription" rows="4" required
                                              placeholder="Décrire le travail à faire..."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type de devoir</label>
                                    <select class="form-control" id="devoirType">
                                        <option value="exercices">Exercices</option>
                                        <option value="recherche">Recherche</option>
                                        <option value="exposé">Exposé</option>
                                        <option value="projet">Projet</option>
                                        <option value="contrôle">Contrôle</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Durée estimée (heures)</label>
                                    <input type="number" class="form-control" id="devoirDuree" min="0.5" max="10" step="0.5" value="1">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Documents joints</label>
                                    <input type="file" class="form-control" id="devoirDocuments" multiple>
                                    <small class="text-muted">Énoncé, ressources...</small>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Annuler</button>
                        <button class="btn btn-primary" onclick="creerNouveauDevoir()">
                            <i class="fas fa-save"></i> Créer le devoir
                        </button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        async function creerNouveauDevoir() {
            const titre = document.getElementById('devoirTitre').value;
            const matiereId = parseInt(document.getElementById('devoirMatiere').value);
            const classeId = parseInt(document.getElementById('devoirClasse').value);
            const dateRendu = document.getElementById('devoirDateRendu').value;
            const description = document.getElementById('devoirDescription').value;
            
            if (!titre || !matiereId || !classeId || !dateRendu || !description) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            if (!SCOLARIS_DATA.devoirs) SCOLARIS_DATA.devoirs = [];
            
            const nouvelId = Math.max(...SCOLARIS_DATA.devoirs.map(d => d.id), 0) + 1;
            const nouveauDevoir = {
                id: nouvelId,
                titre: titre,
                matiere_id: matiereId,
                classe_id: classeId,
                professeur_id: utilisateurCourant.id,
                date_creation: new Date().toISOString().split('T')[0],
                date_rendu: dateRendu,
                description: description,
                type: document.getElementById('devoirType').value,
                duree_estimee: parseFloat(document.getElementById('devoirDuree').value),
                statut: 'à_rendre',
                rendus: 0,
                total_eleves: SCOLARIS_DATA.eleves.filter(e => e.classe_id === classeId).length
            };
            
            SCOLARIS_DATA.devoirs.push(nouveauDevoir);
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Devoir créé avec succès !');
                fermerModal();
                afficherGestionDevoirs();
            } else {
                alert('Erreur lors de la création: ' + result.error);
            }
        }

        function getStatutDevoirBadge(statut) {
            switch(statut) {
                case 'à_rendre': return '<span class="badge badge-warning">À rendre</span>';
                case 'rendu': return '<span class="badge badge-info">Rendu</span>';
                case 'corrigé': return '<span class="badge badge-success">Corrigé</span>';
                case 'en_retard': return '<span class="badge badge-danger">En retard</span>';
                default: return '<span class="badge badge-secondary">' + statut + '</span>';
            }
        }

        // ============================================
        // PARAMÈTRES
        // ============================================
        function afficherParametres() {
            const config = SCOLARIS_DATA.system.config || {};
            const etablissement = SCOLARIS_DATA.system.etablissement;
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Paramètres du système</h1>
                    <button class="btn btn-primary" onclick="sauvegarderParametres()">
                        <i class="fas fa-save"></i> Enregistrer tous les paramètres
                    </button>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="changerOngletParametres('etablissement')">Établissement</div>
                    <div class="tab" onclick="changerOngletParametres('systeme')">Système</div>
                    <div class="tab" onclick="changerOngletParametres('securite')">Sécurité</div>
                    <div class="tab" onclick="changerOngletParametres('sauvegarde')">Sauvegarde</div>
                </div>
                
                <div id="contenuParametres">
                    <div class="form-container">
                        <h3 class="form-title">Informations de l'établissement</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom de l'établissement *</label>
                                <input type="text" class="form-control" id="paramEtablissementNom" 
                                       value="${etablissement.nom}" required>
                            </div>
                            <div class="form-group">
                                <label>Type d'établissement *</label>
                                <select class="form-control" id="paramEtablissementType" required>
                                    <option value="Collège public" ${etablissement.type === 'Collège public' ? 'selected' : ''}>Collège public</option>
                                    <option value="Collège privé" ${etablissement.type === 'Collège privé' ? 'selected' : ''}>Collège privé</option>
                                    <option value="Lycée général" ${etablissement.type === 'Lycée général' ? 'selected' : ''}>Lycée général</option>
                                    <option value="Lycée professionnel" ${etablissement.type === 'Lycée professionnel' ? 'selected' : ''}>Lycée professionnel</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Adresse *</label>
                                <input type="text" class="form-control" id="paramEtablissementAdresse" 
                                       value="${etablissement.adresse}" required>
                            </div>
                            <div class="form-group">
                                <label>Ville *</label>
                                <input type="text" class="form-control" id="paramEtablissementVille" 
                                       value="${etablissement.ville}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Téléphone</label>
                                <input type="text" class="form-control" id="paramEtablissementTelephone" 
                                       value="${etablissement.telephone || ''}">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" class="form-control" id="paramEtablissementEmail" 
                                       value="${etablissement.email || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Année scolaire *</label>
                                <input type="text" class="form-control" id="paramEtablissementAnnee" 
                                       value="${etablissement.annee_scolaire}" required>
                            </div>
                            <div class="form-group">
                                <label>Directeur</label>
                                <input type="text" class="form-control" id="paramEtablissementDirecteur" 
                                       value="${etablissement.directeur || ''}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-container">
                        <h3 class="form-title">Configuration du système</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Thème de l'interface</label>
                                <select class="form-control" id="paramTheme">
                                    <option value="default" ${config.theme === 'default' ? 'selected' : ''}>Par défaut (Bleu)</option>
                                    <option value="dark" ${config.theme === 'dark' ? 'selected' : ''}>Sombre</option>
                                    <option value="green" ${config.theme === 'green' ? 'selected' : ''}>Vert</option>
                                    <option value="red" ${config.theme === 'red' ? 'selected' : ''}>Rouge</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Langue</label>
                                <select class="form-control" id="paramLangue">
                                    <option value="fr" selected>Français</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><input type="checkbox" id="paramNotifications" ${config.notifications ? 'checked' : ''}> Activer les notifications</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="paramExportAuto" ${config.export_auto ? 'checked' : ''}> Export automatique des données</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-container">
                        <h3 class="form-title">Sécurité</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Durée de session (minutes)</label>
                                <input type="number" class="form-control" id="paramDureeSession" 
                                       value="${config.duree_session || 30}" min="5" max="240">
                            </div>
                            <div class="form-group">
                                <label>Complexité des mots de passe</label>
                                <select class="form-control" id="paramComplexitePassword">
                                    <option value="faible" ${config.complexite_password === 'faible' ? 'selected' : ''}>Faible (6 caractères)</option>
                                    <option value="moyenne" ${config.complexite_password === 'moyenne' || !config.complexite_password ? 'selected' : ''}>Moyenne (8 caractères, majuscule, chiffre)</option>
                                    <option value="forte" ${config.complexite_password === 'forte' ? 'selected' : ''}>Forte (12 caractères, complexe)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><input type="checkbox" id="paramForceChangementPassword" ${config.force_changement_password ? 'checked' : ''}> Forcer le changement de mot de passe au premier login</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="paramConnexionDouble" ${config.connexion_double ? 'checked' : ''}> Double authentification pour les administrateurs</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-container">
                        <h3 class="form-title">Sauvegarde et maintenance</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fréquence de sauvegarde automatique</label>
                                <select class="form-control" id="paramFrequenceSauvegarde">
                                    <option value="journaliere" ${config.frequence_sauvegarde === 'journaliere' ? 'selected' : ''}>Quotidienne</option>
                                    <option value="hebdomadaire" ${config.frequence_sauvegarde === 'hebdomadaire' || !config.frequence_sauvegarde ? 'selected' : ''}>Hebdomadaire</option>
                                    <option value="mensuelle" ${config.frequence_sauvegarde === 'mensuelle' ? 'selected' : ''}>Mensuelle</option>
                                    <option value="aucune" ${config.frequence_sauvegarde === 'aucune' ? 'selected' : ''}>Aucune</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Conserver les données pendant</label>
                                <select class="form-control" id="paramConservationDonnees">
                                    <option value="1" ${config.conservation_donnees === '1' ? 'selected' : ''}>1 an</option>
                                    <option value="3" ${config.conservation_donnees === '3' || !config.conservation_donnees ? 'selected' : ''}>3 ans</option>
                                    <option value="5" ${config.conservation_donnees === '5' ? 'selected' : ''}>5 ans</option>
                                    <option value="indefinie" ${config.conservation_donnees === 'indefinie' ? 'selected' : ''}>Indéfiniment</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="sauvegarderDonneesLocal()">
                                <i class="fas fa-download"></i> Sauvegarder maintenant
                            </button>
                            <button class="btn btn-secondary" onclick="restaurerSauvegarde()" style="margin-left: 10px;">
                                <i class="fas fa-upload"></i> Restaurer une sauvegarde
                            </button>
                            <button class="btn btn-danger" onclick="reinitialiserDonnees()" style="margin-left: 10px;">
                                <i class="fas fa-trash"></i> Réinitialiser les données
                            </button>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px;">
                            <h4 style="color: var(--couleur-principale); margin-bottom: 10px;">
                                <i class="fas fa-info-circle"></i> Informations système
                            </h4>
                            <p><strong>Version :</strong> ${SCOLARIS_DATA.system.version}</p>
                            <p><strong>Dernière sauvegarde :</strong> ${config.derniere_sauvegarde ? formatDate(config.derniere_sauvegarde) : 'Jamais'}</p>
                            <p><strong>Taille des données :</strong> ${Math.round(JSON.stringify(SCOLARIS_DATA).length / 1024)} Ko</p>
                            <p><strong>Utilisateurs actifs :</strong> ${SCOLARIS_DATA.utilisateurs.filter(u => u.actif).length}</p>
                            <p><strong>JSONBin ID :</strong> ${JSONBIN_BIN_ID || 'Non configuré'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mention-legale">
                    <i class="fas fa-exclamation-circle"></i>
                    Les modifications sont sauvegardées automatiquement dans JSONBin.io.
                </div>`;
            
            setActiveMenu('parametres');
        }

        async function sauvegarderParametres() {
            // Mettre à jour les informations de l'établissement
            SCOLARIS_DATA.system.etablissement.nom = document.getElementById('paramEtablissementNom').value;
            SCOLARIS_DATA.system.etablissement.type = document.getElementById('paramEtablissementType').value;
            SCOLARIS_DATA.system.etablissement.adresse = document.getElementById('paramEtablissementAdresse').value;
            SCOLARIS_DATA.system.etablissement.ville = document.getElementById('paramEtablissementVille').value;
            SCOLARIS_DATA.system.etablissement.telephone = document.getElementById('paramEtablissementTelephone').value;
            SCOLARIS_DATA.system.etablissement.email = document.getElementById('paramEtablissementEmail').value;
            SCOLARIS_DATA.system.etablissement.annee_scolaire = document.getElementById('paramEtablissementAnnee').value;
            SCOLARIS_DATA.system.etablissement.directeur = document.getElementById('paramEtablissementDirecteur').value;
            
            // Mettre à jour la configuration
            SCOLARIS_DATA.system.config = {
                theme: document.getElementById('paramTheme').value,
                notifications: document.getElementById('paramNotifications').checked,
                export_auto: document.getElementById('paramExportAuto').checked,
                duree_session: parseInt(document.getElementById('paramDureeSession').value),
                complexite_password: document.getElementById('paramComplexitePassword').value,
                force_changement_password: document.getElementById('paramForceChangementPassword').checked,
                connexion_double: document.getElementById('paramConnexionDouble').checked,
                frequence_sauvegarde: document.getElementById('paramFrequenceSauvegarde').value,
                conservation_donnees: document.getElementById('paramConservationDonnees').value,
                derniere_sauvegarde: new Date().toISOString().split('T')[0]
            };
            
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Paramètres enregistrés avec succès !');
                // Mettre à jour l'affichage de l'établissement
                afficherInformationsEtablissement();
            } else {
                alert('Erreur lors de l\'enregistrement: ' + result.error);
            }
        }

        function sauvegarderDonneesLocal() {
            const dataStr = JSON.stringify(SCOLARIS_DATA, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `scolaris_sauvegarde_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('Sauvegarde téléchargée avec succès !');
        }

        function restaurerSauvegarde() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async function(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const donnees = JSON.parse(e.target.result);
                        
                        if (!donnees.system || !donnees.utilisateurs) {
                            throw new Error('Format de fichier invalide');
                        }
                        
                        if (confirm('Voulez-vous vraiment restaurer cette sauvegarde ? Toutes les données actuelles seront perdues.')) {
                            const result = await sauvegarderDonnees(donnees);
                            
                            if (result.success) {
                                alert('Sauvegarde restaurée avec succès ! Redémarrage nécessaire.');
                                location.reload();
                            } else {
                                alert('Erreur lors de la restauration: ' + result.error);
                            }
                        }
                    } catch (error) {
                        alert('Erreur : Le fichier n\'est pas une sauvegarde valide de SCOLARIS');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        async function reinitialiserDonnees() {
            if (!confirm('ATTENTION : Cette action supprimera TOUTES les données (utilisateurs, élèves, classes, notes, etc.) et réinitialisera le système. Cette action est irréversible. Continuer ?')) {
                return;
            }
            
            if (!confirm('Êtes-vous ABSOLUMENT sûr ? Toutes vos données seront perdues.')) {
                return;
            }
            
            // Garder seulement l'administrateur principal
            const admin = SCOLARIS_DATA.utilisateurs.find(u => u.id === 1);
            const etablissement = SCOLARIS_DATA.system.etablissement;
            
            SCOLARIS_DATA = {
                system: {
                    nom: "SCOLARIS",
                    version: "5.1.0",
                    etablissement: etablissement,
                    config: SCOLARIS_DATA.system.config || {}
                },
                utilisateurs: [admin],
                roles: SCOLARIS_DATA.roles,
                classes: [],
                eleves: [],
                matieres: SCOLARIS_DATA.matieres,
                notes: [],
                absences: [],
                retards: [],
                sanctions: [],
                observations: [],
                devoirs: [],
                cahier_textes: [],
                emploi_du_temps: [],
                messages: [],
                documents: []
            };
            
            const result = await sauvegarderDonnees(SCOLARIS_DATA);
            
            if (result.success) {
                alert('Données réinitialisées avec succès !');
                location.reload();
            } else {
                alert('Erreur lors de la réinitialisation: ' + result.error);
            }
        }

        // ============================================
        // FONCTIONS AUXILIAIRES
        // ============================================
        function rechercherEleves(term) {
            const rows = document.querySelectorAll('#tableEleves tbody tr');
            const searchTerm = term.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filtrerElevesParClasse(classeId) {
            const rows = document.querySelectorAll('#tableEleves tbody tr');
            
            rows.forEach(row => {
                const eleveId = parseInt(row.dataset.eleveId);
                const eleve = SCOLARIS_DATA.eleves.find(e => e.id === eleveId);
                
                if (!classeId || (eleve && eleve.classe_id === parseInt(classeId))) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Fonctions de placeholder pour les autres modules
        function changerOngletSanctions(tab) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Implémentation simplifiée
            alert('Filtrage par type de sanction: ' + tab);
        }

        function filtrerObservations() {
            // Implémentation simplifiée
            alert('Filtrage des observations');
        }

        function filtrerCahierTextes() {
            // Implémentation simplifiée
            alert('Filtrage du cahier de textes');
        }

        function filtrerEmploiDuTemps() {
            // Implémentation simplifiée
            alert('Filtrage de l\'emploi du temps');
        }

        function changerOngletDevoirs(tab) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Implémentation simplifiée
            alert('Filtrage par statut de devoir: ' + tab);
        }

        function changerOngletParametres(tab) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Implémentation simplifiée
            alert('Navigation vers l\'onglet: ' + tab);
        }

        // Fonctions de simulation pour les boutons non implémentés
        function genererEmploiDuTemps() {
            alert('Génération automatique de l\'emploi du temps (simulation)');
        }

        function genererListeClasse(classeId) {
            alert('Génération de la liste de classe au format PDF (simulation)');
        }

        function genererFicheElevePDF(eleveId) {
            alert('Génération de la fiche élève au format PDF (simulation)');
        }

        function voirNotesEleve(eleveId) {
            alert('Affichage des notes de l\'élève (simulation)');
        }

        function affecterElevesClasse(classeId) {
            alert('Affectation d\'élèves à la classe (simulation)');
        }

        function ajouterObservationEleve(eleveId) {
            alert('Ajout d\'une observation pour l\'élève (simulation)');
        }

        function ajouterSanctionEleve(eleveId) {
            alert('Ajout d\'une sanction pour l\'élève (simulation)');
        }

        function voirDetailsSanction(sanctionId) {
            alert('Détails de la sanction (simulation)');
        }

        function supprimerSanction(sanctionId) {
            if (confirm('Supprimer cette sanction ?')) {
                alert('Sanction supprimée (simulation)');
            }
        }

        function supprimerObservation(observationId) {
            if (confirm('Supprimer cette observation ?')) {
                alert('Observation supprimée (simulation)');
            }
        }

        function modifierClasse(classeId) {
            alert('Modification de la classe (simulation)');
        }

        function supprimerClasse(classeId) {
            if (confirm('Supprimer cette classe ?')) {
                alert('Classe supprimée (simulation)');
            }
        }

        function modifierMatiere(matiereId) {
            alert('Modification de la matière (simulation)');
        }

        function supprimerMatiere(matiereId) {
            if (confirm('Supprimer cette matière ?')) {
                alert('Matière supprimée (simulation)');
            }
        }

        function modifierUtilisateur(utilisateurId) {
            alert('Modification de l\'utilisateur (simulation)');
        }

        function supprimerUtilisateur(utilisateurId) {
            if (confirm('Supprimer cet utilisateur ?')) {
                alert('Utilisateur supprimé (simulation)');
            }
        }

        function voirDetailsCoursEDT(coursId) {
            alert('Détails du cours dans l\'emploi du temps (simulation)');
        }

        function modifierCreneauEDT(creneauId) {
            alert('Modification du créneau (simulation)');
        }

        function supprimerCreneauEDT(creneauId) {
            if (confirm('Supprimer ce créneau ?')) {
                alert('Créneau supprimé (simulation)');
            }
        }

        function voirDetailsDevoir(devoirId) {
            alert('Détails du devoir (simulation)');
        }

        function corrigerDevoir(devoirId) {
            alert('Correction du devoir (simulation)');
        }

        function modifierCours(coursId) {
            alert('Modification du cours (simulation)');
        }

        function modifierNote(noteId) {
            alert('Modification de la note (simulation)');
        }

        function supprimerNote(noteId) {
            if (confirm('Supprimer cette note ?')) {
                alert('Note supprimée (simulation)');
            }
        }

        function modifierAbsence(absenceId) {
            alert('Modification de l\'absence (simulation)');
        }

        function supprimerAbsence(absenceId) {
            if (confirm('Supprimer cette absence ?')) {
                alert('Absence supprimée (simulation)');
            }
        }

        function filtrerNotes() {
            alert('Filtrage des notes (simulation)');
        }

        function filtrerAbsences() {
            alert('Filtrage des absences (simulation)');
        }

        // ============================================
        // FONCTIONS POUR LES AUTRES RÔLES
        // ============================================
        function afficherMesClasses() {
            const mesClasses = SCOLARIS_DATA.classes.filter(c => 
                c.prof_principal_id === utilisateurCourant.id ||
                (utilisateurCourant.classes && utilisateurCourant.classes.includes(c.id))
            );
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Mes classes</h1>
                
                <div class="cards-container">
                    ${mesClasses.map(classe => {
                        const effectif = SCOLARIS_DATA.eleves.filter(e => e.classe_id === classe.id).length;
                        return `
                        <div class="card" onclick="voirDetailsClasse('${classe.id}')" style="cursor: pointer;">
                            <div class="card-title">${classe.nom}</div>
                            <div class="card-value">${effectif}</div>
                            <div class="card-subtitle">élèves</div>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-door-closed"></i> ${classe.salle || 'Salle non attribuée'}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
                
                ${mesClasses.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-chalkboard-teacher" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucune classe assignée</h3>
                    <p style="color: #888; margin-bottom: 25px;">Contactez l'administration pour vous affecter à des classes.</p>
                </div>` : ''}`;
            
            setActiveMenu('mes_classes');
        }

        function afficherMesNotes() {
            const eleveId = utilisateurCourant.eleve_id;
            const eleve = SCOLARIS_DATA.eleves.find(e => e.id === eleveId);
            
            if (!eleve) {
                document.getElementById('contenuPrincipal').innerHTML = `
                    <div class="form-container" style="text-align: center; padding: 40px;">
                        <i class="fas fa-user-graduate" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #666; margin-bottom: 15px;">Profil élève non trouvé</h3>
                        <p style="color: #888;">Contactez l'administration.</p>
                    </div>`;
                return;
            }
            
            const notes = SCOLARIS_DATA.notes.filter(n => n.eleve_id === eleveId);
            const moyenneGenerale = notes.length > 0 ? 
                (notes.reduce((sum, n) => sum + n.valeur, 0) / notes.length).toFixed(2) : 'N/A';
            
            // Calculer la moyenne par matière
            const notesParMatiere = {};
            notes.forEach(note => {
                if (!notesParMatiere[note.matiere_id]) {
                    notesParMatiere[note.matiere_id] = [];
                }
                notesParMatiere[note.matiere_id].push(note);
            });
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Mes notes</h1>
                
                <div class="cards-container">
                    <div class="card">
                        <div class="card-title">Moyenne générale</div>
                        <div class="card-value">${moyenneGenerale}/20</div>
                        <div class="card-subtitle">${notes.length} notes</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Meilleure note</div>
                        <div class="card-value">${notes.length > 0 ? Math.max(...notes.map(n => n.valeur)).toFixed(2) : '0.00'}/20</div>
                        <div class="card-subtitle">Maximum</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Plus basse note</div>
                        <div class="card-value">${notes.length > 0 ? Math.min(...notes.map(n => n.valeur)).toFixed(2) : '0.00'}/20</div>
                        <div class="card-subtitle">Minimum</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Mes notes par matière</div>
                    </div>
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Matière</th>
                                    <th>Nombre de notes</th>
                                    <th>Moyenne</th>
                                    <th>Dernière note</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(notesParMatiere).map(([matiereId, notesMatiere]) => {
                                    const matiere = SCOLARIS_DATA.matieres.find(m => m.id === parseInt(matiereId));
                                    const moyenneMatiere = (notesMatiere.reduce((sum, n) => sum + n.valeur, 0) / notesMatiere.length).toFixed(2);
                                    const derniereNote = notesMatiere.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                                    const noteClass = moyenneMatiere < 10 ? 'badge-danger' : 
                                                     moyenneMatiere < 12 ? 'badge-warning' : 
                                                     moyenneMatiere < 14 ? 'badge-primary' : 'badge-success';
                                    
                                    return `
                                    <tr>
                                        <td><strong>${matiere ? matiere.nom : 'Inconnu'}</strong></td>
                                        <td>${notesMatiere.length}</td>
                                        <td><span class="badge ${noteClass}">${moyenneMatiere}/20</span></td>
                                        <td>${derniereNote ? derniereNote.valeur.toFixed(2) + '/20 (' + formatDate(derniereNote.date) + ')' : 'Aucune'}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-small" onclick="voirNotesMatiere(${matiereId})">
                                                <i class="fas fa-eye"></i> Voir
                                            </button>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            setActiveMenu('mes_notes');
        }

        function afficherEmploiDuTempsEleve() {
            const eleveId = utilisateurCourant.eleve_id;
            const eleve = SCOLARIS_DATA.eleves.find(e => e.id === eleveId);
            
            if (!eleve) {
                document.getElementById('contenuPrincipal').innerHTML = `
                    <div class="form-container" style="text-align: center; padding: 40px;">
                        <i class="fas fa-user-graduate" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #666; margin-bottom: 15px;">Profil élève non trouvé</h3>
                        <p style="color: #888;">Contactez l'administration.</p>
                    </div>`;
                return;
            }
            
            const emploi = SCOLARIS_DATA.emploi_du_temps || [];
            const coursClasse = emploi.filter(e => e.classe_id === eleve.classe_id);
            const jours = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
            const creneaux = ['8:30-9:30', '9:30-10:30', '10:45-11:45', '13:30-14:30', '14:30-15:30', '15:45-16:45'];
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Mon emploi du temps</h1>
                
                <div class="emploi-container">
                    <div class="emploi-cell emploi-header">Heure</div>
                    ${jours.map(jour => `<div class="emploi-cell emploi-header">${jour.charAt(0).toUpperCase() + jour.slice(1)}</div>`).join('')}
                    
                    ${creneaux.map((creneau, index) => {
                        return `
                        <div class="emploi-cell emploi-header">${creneau}</div>
                        ${jours.map(jour => {
                            const cours = coursClasse.find(c => 
                                c.jour === jour && c.creneau === index
                            );
                            
                            if (cours) {
                                const matiere = SCOLARIS_DATA.matieres.find(m => m.id === cours.matiere_id);
                                const professeur = SCOLARIS_DATA.utilisateurs.find(u => u.id === cours.professeur_id);
                                return `
                                <div class="emploi-cell">
                                    <div class="emploi-creneau" style="border-left-color: ${matiere ? matiere.couleur : '#3498DB'}">
                                        <strong>${matiere ? matiere.nom.substring(0, 15) : 'Cours'}</strong><br>
                                        <small>${professeur ? professeur.prenom.charAt(0) + '. ' + professeur.nom : ''}</small><br>
                                        <small>${cours.salle || ''}</small>
                                    </div>
                                </div>`;
                            } else {
                                return `<div class="emploi-cell"></div>`;
                            }
                        }).join('')}`;
                    }).join('')}
                </div>`;
            
            setActiveMenu('emploi_temps');
        }

        function afficherMesDevoirs() {
            const eleveId = utilisateurCourant.eleve_id;
            const eleve = SCOLARIS_DATA.eleves.find(e => e.id === eleveId);
            
            if (!eleve) {
                document.getElementById('contenuPrincipal').innerHTML = `
                    <div class="form-container" style="text-align: center; padding: 40px;">
                        <i class="fas fa-user-graduate" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #666; margin-bottom: 15px;">Profil élève non trouvé</h3>
                        <p style="color: #888;">Contactez l'administration.</p>
                    </div>`;
                return;
            }
            
            const devoirs = SCOLARIS_DATA.devoirs.filter(d => d.classe_id === eleve.classe_id);
            const devoirsARendre = devoirs.filter(d => d.statut === 'à_rendre');
            const devoirsRendus = devoirs.filter(d => d.statut === 'rendu' || d.statut === 'corrigé');
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Mes devoirs</h1>
                
                <div class="cards-container">
                    <div class="card">
                        <div class="card-title">À rendre</div>
                        <div class="card-value">${devoirsARendre.length}</div>
                        <div class="card-subtitle">En attente</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Rendus</div>
                        <div class="card-value">${devoirsRendus.length}</div>
                        <div class="card-subtitle">Terminés</div>
                    </div>
                    <div class="card">
                        <div class="card-title">En retard</div>
                        <div class="card-value">${devoirsARendre.filter(d => new Date(d.date_rendu) < new Date()).length}</div>
                        <div class="card-subtitle">Retard</div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="changerOngletDevoirsEleve('à_rendre')">À rendre</div>
                    <div class="tab" onclick="changerOngletDevoirsEleve('rendu')">Rendus</div>
                    <div class="tab" onclick="changerOngletDevoirsEleve('corrigé')">Corrigés</div>
                </div>
                
                <div id="contenuDevoirsEleve">
                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">Devoirs à rendre (${devoirsARendre.length})</div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Matière</th>
                                        <th>Titre</th>
                                        <th>À rendre pour le</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${devoirsARendre.sort((a, b) => new Date(a.date_rendu) - new Date(b.date_rendu))
                                        .map(devoir => {
                                            const matiere = SCOLARIS_DATA.matieres.find(m => m.id === devoir.matiere_id);
                                            const estEnRetard = new Date(devoir.date_rendu) < new Date();
                                            const statutBadge = estEnRetard ? 
                                                '<span class="badge badge-danger">En retard</span>' : 
                                                '<span class="badge badge-warning">À rendre</span>';
                                            
                                            return `
                                            <tr>
                                                <td>${matiere ? matiere.nom : 'Inconnu'}</td>
                                                <td>${devoir.titre}</td>
                                                <td>${formatDate(devoir.date_rendu)}</td>
                                                <td>${statutBadge}</td>
                                                <td>
                                                    <button class="btn btn-secondary btn-small" onclick="voirDetailsDevoirEleve(${devoir.id})">
                                                        <i class="fas fa-eye"></i> Voir
                                                    </button>
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            
            setActiveMenu('mes_devoirs');
        }

        function afficherMesObservations() {
            const eleveId = utilisateurCourant.eleve_id;
            const observations = (SCOLARIS_DATA.observations || []).filter(o => 
                o.eleve_id === eleveId && o.visible_eleve !== false
            );
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Mes observations</h1>
                
                <div class="cards-container">
                    <div class="card">
                        <div class="card-title">Observations positives</div>
                        <div class="card-value">${observations.filter(o => o.type === 'positive').length}</div>
                        <div class="card-subtitle">Encouragements</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Observations négatives</div>
                        <div class="card-value">${observations.filter(o => o.type === 'negative').length}</div>
                        <div class="card-subtitle">À améliorer</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Observations neutres</div>
                        <div class="card-value">${observations.filter(o => o.type === 'neutre').length}</div>
                        <div class="card-subtitle">Informatives</div>
                    </div>
                </div>
                
                <div id="listeMesObservations">
                    ${observations.length > 0 ? observations.map(observation => {
                        const matiere = observation.matiere_id ? 
                            SCOLARIS_DATA.matieres.find(m => m.id === observation.matiere_id) : null;
                        const typeClass = observation.type === 'positive' ? 'observation-positive' : 
                                         observation.type === 'negative' ? 'observation-negative' : 'observation-neutre';
                        const typeIcon = observation.type === 'positive' ? 'fa-thumbs-up' : 
                                        observation.type === 'negative' ? 'fa-thumbs-down' : 'fa-minus';
                        const typeColor = observation.type === 'positive' ? '#27AE60' : 
                                         observation.type === 'negative' ? '#E74C3C' : '#95A5A6';
                        
                        return `
                        <div class="observation-card ${typeClass}">
                            <div class="cours-header">
                                <div>
                                    <i class="fas ${typeIcon}" style="color: ${typeColor}; margin-right: 8px;"></i>
                                    <strong>${observation.titre}</strong>
                                    ${matiere ? ' - ' + matiere.nom : ''}
                                </div>
                                <div class="cours-horaire">${formatDate(observation.date)}</div>
                            </div>
                            <p style="color: #666; margin-top: 10px;">${observation.description}</p>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #888;">
                                Par ${observation.auteur_nom || 'Inconnu'}
                            </div>
                        </div>`;
                    }).join('') : `
                    <div class="form-container" style="text-align: center; padding: 40px;">
                        <i class="fas fa-sticky-note" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #666; margin-bottom: 15px;">Aucune observation</h3>
                        <p style="color: #888; margin-bottom: 25px;">Vos observations apparaîtront ici.</p>
                    </div>`}
                </div>`;
            
            setActiveMenu('mes_observations');
        }

        // ============================================
        // FONCTIONS POUR LES PARENTS
        // ============================================
        function afficherEnfants() {
            const enfants = SCOLARIS_DATA.eleves.filter(e => 
                e.responsable_1 === utilisateurCourant.nom || 
                e.email_responsable_1 === utilisateurCourant.email
            );
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Mes enfants</h1>
                
                <div class="cards-container">
                    ${enfants.map(enfant => {
                        const classe = SCOLARIS_DATA.classes.find(c => c.id === enfant.classe_id);
                        const notes = SCOLARIS_DATA.notes.filter(n => n.eleve_id === enfant.id);
                        const moyenne = notes.length > 0 ? 
                            (notes.reduce((sum, n) => sum + n.valeur, 0) / notes.length).toFixed(1) : 'N/A';
                        const absences = SCOLARIS_DATA.absences.filter(a => a.eleve_id === enfant.id).length;
                        const observations = (SCOLARIS_DATA.observations || []).filter(o => o.eleve_id === enfant.id).length;
                        
                        return `
                        <div class="card" onclick="voirFicheEleveParent(${enfant.id})" style="cursor: pointer;">
                            <div class="card-title">${enfant.prenom} ${enfant.nom}</div>
                            <div class="card-value">${classe ? classe.nom : 'Non affecté'}</div>
                            <div class="card-subtitle">Classe</div>
                            <div style="margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                    <div>
                                        <i class="fas fa-graduation-cap"></i> ${moyenne}/20
                                    </div>
                                    <div>
                                        <i class="fas fa-user-clock"></i> ${absences}
                                    </div>
                                    <div>
                                        <i class="fas fa-sticky-note"></i> ${observations}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
                
                ${enfants.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-child" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucun enfant associé</h3>
                    <p style="color: #888; margin-bottom: 25px;">Contactez l'établissement pour associer vos enfants.</p>
                </div>` : ''}`;
            
            setActiveMenu('enfants');
        }

        function voirFicheEleveParent(eleveId) {
            const eleve = SCOLARIS_DATA.eleves.find(e => e.id === eleveId);
            if (!eleve) return;
            
            const classe = SCOLARIS_DATA.classes.find(c => c.id === eleve.classe_id);
            const notes = SCOLARIS_DATA.notes.filter(n => n.eleve_id === eleveId);
            const moyenne = notes.length > 0 ? 
                (notes.reduce((sum, n) => sum + n.valeur, 0) / notes.length).toFixed(2) : 'N/A';
            const absences = SCOLARIS_DATA.absences.filter(a => a.eleve_id === eleveId);
            const observations = (SCOLARIS_DATA.observations || []).filter(o => o.eleve_id === eleveId);
            
            const modalHtml = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">👨‍👦 Fiche de ${eleve.prenom} ${eleve.nom}</div>
                        <button class="modal-close" onclick="fermerModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: flex; gap: 30px; margin-bottom: 25px;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Informations</h4>
                                <p><strong>Classe :</strong> ${classe ? classe.nom : 'Non affecté'}</p>
                                <p><strong>Professeur principal :</strong> ${classe ? classe.prof_principal : 'Non attribué'}</p>
                                <p><strong>Moyenne générale :</strong> <strong>${moyenne}/20</strong></p>
                                <p><strong>Absences cette année :</strong> ${absences.length}</p>
                                <p><strong>Observations :</strong> ${observations.length}</p>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Contact</h4>
                                <p><strong>Téléphone classe :</strong> ${SCOLARIS_DATA.system.etablissement.telephone || 'Non renseigné'}</p>
                                <p><strong>Email établissement :</strong> ${SCOLARIS_DATA.system.etablissement.email || 'Non renseigné'}</p>
                                <p><strong>Salle :</strong> ${classe ? classe.salle || 'Non attribuée' : ''}</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--couleur-principale); margin-bottom: 15px;">Actions</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="voirNotesEnfant(${eleveId})">
                                    <i class="fas fa-graduation-cap"></i> Voir les notes
                                </button>
                                <button class="btn btn-secondary" onclick="voirAbsencesEnfant(${eleveId})">
                                    <i class="fas fa-user-clock"></i> Voir les absences
                                </button>
                                <button class="btn btn-secondary" onclick="voirObservationsEnfant(${eleveId})">
                                    <i class="fas fa-sticky-note"></i> Voir les observations
                                </button>
                                <button class="btn btn-secondary" onclick="voirEmploiEnfant(${eleveId})">
                                    <i class="fas fa-calendar-alt"></i> Emploi du temps
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fermerModal()">Fermer</button>
                    </div>
                </div>`;
            
            ouvrirModal(modalHtml);
        }

        function afficherNotesEnfants() {
            const enfants = SCOLARIS_DATA.eleves.filter(e => 
                e.responsable_1 === utilisateurCourant.nom || 
                e.email_responsable_1 === utilisateurCourant.email
            );
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Notes de mes enfants</h1>
                
                ${enfants.map(enfant => {
                    const classe = SCOLARIS_DATA.classes.find(c => c.id === enfant.classe_id);
                    const notes = SCOLARIS_DATA.notes.filter(n => n.eleve_id === enfant.id);
                    const moyenne = notes.length > 0 ? 
                        (notes.reduce((sum, n) => sum + n.valeur, 0) / notes.length).toFixed(2) : 'N/A';
                    
                    // Calculer la moyenne par matière
                    const notesParMatiere = {};
                    notes.forEach(note => {
                        if (!notesParMatiere[note.matiere_id]) {
                            notesParMatiere[note.matiere_id] = [];
                        }
                        notesParMatiere[note.matiere_id].push(note);
                    });
                    
                    return `
                    <div class="form-container" style="margin-bottom: 30px;">
                        <h3 class="form-title">${enfant.prenom} ${enfant.nom} - ${classe ? classe.nom : ''}</h3>
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--couleur-principale); margin-right: 20px;">
                                Moyenne : ${moyenne}/20
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${notes.length} notes enregistrées
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Matière</th>
                                            <th>Moyenne</th>
                                            <th>Nombre de notes</th>
                                            <th>Dernière note</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(notesParMatiere).map(([matiereId, notesMatiere]) => {
                                            const matiere = SCOLARIS_DATA.matieres.find(m => m.id === parseInt(matiereId));
                                            const moyenneMatiere = (notesMatiere.reduce((sum, n) => sum + n.valeur, 0) / notesMatiere.length).toFixed(2);
                                            const derniereNote = notesMatiere.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                                            const noteClass = moyenneMatiere < 10 ? 'badge-danger' : 
                                                             moyenneMatiere < 12 ? 'badge-warning' : 
                                                             moyenneMatiere < 14 ? 'badge-primary' : 'badge-success';
                                            
                                            return `
                                            <tr>
                                                <td><strong>${matiere ? matiere.nom : 'Inconnu'}</strong></td>
                                                <td><span class="badge ${noteClass}">${moyenneMatiere}/20</span></td>
                                                <td>${notesMatiere.length}</td>
                                                <td>${derniereNote ? derniereNote.valeur.toFixed(2) + '/20 (' + formatDate(derniereNote.date) + ')' : 'Aucune'}</td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                }).join('')}
                
                ${enfants.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-child" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucun enfant associé</h3>
                    <p style="color: #888; margin-bottom: 25px;">Contactez l'établissement pour associer vos enfants.</p>
                </div>` : ''}`;
            
            setActiveMenu('notes_enfants');
        }

        function afficherAbsencesEnfants() {
            const enfants = SCOLARIS_DATA.eleves.filter(e => 
                e.responsable_1 === utilisateurCourant.nom || 
                e.email_responsable_1 === utilisateurCourant.email
            );
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Absences de mes enfants</h1>
                
                ${enfants.map(enfant => {
                    const classe = SCOLARIS_DATA.classes.find(c => c.id === enfant.classe_id);
                    const absences = SCOLARIS_DATA.absences.filter(a => a.eleve_id === enfant.id);
                    const absencesJustifiees = absences.filter(a => a.justifiee).length;
                    const absencesNonJustifiees = absences.length - absencesJustifiees;
                    
                    return `
                    <div class="form-container" style="margin-bottom: 30px;">
                        <h3 class="form-title">${enfant.prenom} ${enfant.nom} - ${classe ? classe.nom : ''}</h3>
                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div class="card" style="flex: 1; margin-bottom: 0;">
                                <div class="card-title">Total des absences</div>
                                <div class="card-value">${absences.length}</div>
                                <div class="card-subtitle">Cette année</div>
                            </div>
                            <div class="card" style="flex: 1; margin-bottom: 0;">
                                <div class="card-title">Absences justifiées</div>
                                <div class="card-value">${absencesJustifiees}</div>
                                <div class="card-subtitle">Avec justificatif</div>
                            </div>
                            <div class="card" style="flex: 1; margin-bottom: 0;">
                                <div class="card-title">Absences non justifiées</div>
                                <div class="card-value">${absencesNonJustifiees}</div>
                                <div class="card-subtitle">Sans justificatif</div>
                            </div>
                        </div>
                        
                        ${absences.length > 0 ? `
                        <div class="table-container">
                            <div class="table-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Justifiée</th>
                                            <th>Motif</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${absences.sort((a, b) => new Date(b.date) - new Date(a.date))
                                            .map(absence => {
                                                const justifieeBadge = absence.justifiee ? 
                                                    '<span class="badge badge-success">Oui</span>' : 
                                                    '<span class="badge badge-danger">Non</span>';
                                                const typeBadge = absence.type === 'complet' ? 
                                                    '<span class="badge badge-warning">Complète</span>' : 
                                                    '<span class="badge badge-info">Partielle</span>';
                                                
                                                return `
                                                <tr>
                                                    <td>${formatDate(absence.date)}</td>
                                                    <td>${typeBadge}</td>
                                                    <td>${justifieeBadge}</td>
                                                    <td>${absence.motif || ''}</td>
                                                </tr>`;
                                            }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>` : `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #ddd; margin-bottom: 10px;"></i>
                            <p>Aucune absence enregistrée</p>
                        </div>`}
                    </div>`;
                }).join('')}
                
                ${enfants.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-child" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucun enfant associé</h3>
                    <p style="color: #888; margin-bottom: 25px;">Contactez l'établissement pour associer vos enfants.</p>
                </div>` : ''}`;
            
            setActiveMenu('absences_enfants');
        }

        function afficherObservationsEnfants() {
            const enfants = SCOLARIS_DATA.eleves.filter(e => 
                e.responsable_1 === utilisateurCourant.nom || 
                e.email_responsable_1 === utilisateurCourant.email
            );
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <h1 style="margin-bottom: 25px; color: var(--couleur-principale);">Observations de mes enfants</h1>
                
                ${enfants.map(enfant => {
                    const classe = SCOLARIS_DATA.classes.find(c => c.id === enfant.classe_id);
                    const observations = (SCOLARIS_DATA.observations || []).filter(o => o.eleve_id === enfant.id);
                    const observationsPositives = observations.filter(o => o.type === 'positive').length;
                    const observationsNegatives = observations.filter(o => o.type === 'negative').length;
                    const observationsNeutres = observations.filter(o => o.type === 'neutre').length;
                    
                    return `
                    <div class="form-container" style="margin-bottom: 30px;">
                        <h3 class="form-title">${enfant.prenom} ${enfant.nom} - ${classe ? classe.nom : ''}</h3>
                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div class="card" style="flex: 1; margin-bottom: 0;">
                                <div class="card-title">Positives</div>
                                <div class="card-value">${observationsPositives}</div>
                                <div class="card-subtitle">Encouragements</div>
                            </div>
                            <div class="card" style="flex: 1; margin-bottom: 0;">
                                <div class="card-title">Négatives</div>
                                <div class="card-value">${observationsNegatives}</div>
                                <div class="card-subtitle">À améliorer</div>
                            </div>
                            <div class="card" style="flex: 1; margin-bottom: 0;">
                                <div class="card-title">Neutres</div>
                                <div class="card-value">${observationsNeutres}</div>
                                <div class="card-subtitle">Informatives</div>
                            </div>
                        </div>
                        
                        ${observations.length > 0 ? `
                        <div id="listeObservationsEnfant">
                            ${observations.map(observation => {
                                const matiere = observation.matiere_id ? 
                                    SCOLARIS_DATA.matieres.find(m => m.id === observation.matiere_id) : null;
                                const typeClass = observation.type === 'positive' ? 'observation-positive' : 
                                                 observation.type === 'negative' ? 'observation-negative' : 'observation-neutre';
                                const typeIcon = observation.type === 'positive' ? 'fa-thumbs-up' : 
                                                observation.type === 'negative' ? 'fa-thumbs-down' : 'fa-minus';
                                const typeColor = observation.type === 'positive' ? '#27AE60' : 
                                                 observation.type === 'negative' ? '#E74C3C' : '#95A5A6';
                                
                                return `
                                <div class="observation-card ${typeClass}">
                                    <div class="cours-header">
                                        <div>
                                            <i class="fas ${typeIcon}" style="color: ${typeColor}; margin-right: 8px;"></i>
                                            <strong>${observation.titre}</strong>
                                            ${matiere ? ' - ' + matiere.nom : ''}
                                        </div>
                                        <div class="cours-horaire">${formatDate(observation.date)}</div>
                                    </div>
                                    <p style="color: #666; margin-top: 10px;">${observation.description}</p>
                                    <div style="margin-top: 10px; font-size: 0.9rem; color: #888;">
                                        Par ${observation.auteur_nom || 'Inconnu'}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>` : `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-sticky-note" style="font-size: 3rem; color: #ddd; margin-bottom: 10px;"></i>
                            <p>Aucune observation enregistrée</p>
                        </div>`}
                    </div>`;
                }).join('')}
                
                ${enfants.length === 0 ? `
                <div class="form-container" style="text-align: center; padding: 40px;">
                    <i class="fas fa-child" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 15px;">Aucun enfant associé</h3>
                    <p style="color: #888; margin-bottom: 25px;">Contactez l'établissement pour associer vos enfants.</p>
                </div>` : ''}`;
            
            setActiveMenu('observations_enfants');
        }

        // ============================================
        // FONCTIONS POUR LES ENSEIGNANTS
        // ============================================
        function afficherGestionEnseignants() {
            const enseignants = SCOLARIS_DATA.utilisateurs.filter(u => u.role === 'enseignant');
            
            document.getElementById('contenuPrincipal').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h1 style="color: var(--couleur-principale);">Gestion des enseignants</h1>
                    <button class="btn btn-primary" onclick="ouvrirModalNouvelEnseignant()">
                        <i class="fas fa-plus"></i> Nouvel enseignant
                    </button>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Enseignants (${enseignants.length})</div>
                    </div>
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Email</th>
                                    <th>Téléphone</th>
                                    <th>Matières</th>
                                    <th>Classes</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${enseignants.map(enseignant => {
                                    const matieres = enseignant.matieres ? 
                                        enseignant.matieres.map(mId => {
                                            const matiere = SCOLARIS_DATA.matieres.find(m => m.id === mId);
                                            return matiere ? matiere.nom : 'Inconnu';
                                        }).join(', ') : 'Non assigné';
                                    
                                    const classes = SCOLARIS_DATA.classes.filter(c => 
                                        c.prof_principal_id === enseignant.id
                                    ).map(c => c.nom).join(', ') || 'Aucune';
                                    
                                    return `
                                    <tr>
                                        <td><strong>${enseignant.nom}</strong></td>
                                        <td>${enseignant.prenom}</td>
                                        <td>${enseignant.email || ''}</td>
                                        <td>${enseignant.telephone || ''}</td>
                                        <td>${matieres}</td>
                                        <td>${classes}</td>
                                        <td>${enseignant.actif ? 
                                            '<span class="badge badge-success">Actif</span>' : 
                                            '<span class="badge badge-danger">Inactif</span>'}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-secondary btn-small" onclick="modifierEnseignant(${enseignant.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-small" onclick="supprimerEnseignant(${enseignant.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            setActiveMenu('enseignants');
        }

        // ============================================
        // FONCTIONS POUR LE TABLEAU DE BORD PARENT
        // ============================================
        function afficherTableauDeBordParent() {
            afficherTableauDeBord();
        }

        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si un utilisateur est déjà connecté
            const userStr = localStorage.getItem('SCOLARIS_USER');
            if (userStr) {
                utilisateurCourant = JSON.parse(userStr);
                showDashboard();
            }
            
            // Charger la clé API si disponible
            const savedApiKey = localStorage.getItem('JSONBIN_API_KEY');
            const savedBinId = localStorage.getItem('JSONBIN_BIN_ID');
            
            if (savedApiKey) {
                document.getElementById('jsonbinKey').value = savedApiKey;
                JSONBIN_API_KEY = savedApiKey;
            }
            
            if (savedBinId) {
                document.getElementById('jsonbinId').value = savedBinId;
                JSONBIN_BIN_ID = savedBinId;
            }
        });
    </script>
</body>
</html>
